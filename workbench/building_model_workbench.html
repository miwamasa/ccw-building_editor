<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建物モデルワークベンチ - Building Model Workbench</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-section h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-button {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            background: #f5f5f5;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-button:hover {
            background: #e0e0e0;
        }

        .nav-button.active {
            background: #667eea;
            color: white;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        td input,
        td select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 13px;
        }

        .delete-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #e53e3e;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        .mapping-result {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }

        .mapping-item {
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .confidence-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .confidence-high {
            background: #d1fae5;
            color: #065f46;
        }

        .confidence-medium {
            background: #fed7aa;
            color: #92400e;
        }

        .confidence-low {
            background: #fecaca;
            color: #991b1b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #e0e0e0;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: #d0d0d0;
        }

        input[type="file"] {
            display: none;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-connected {
            background: #48bb78;
        }

        .status-disconnected {
            background: #f56565;
        }

        .api-config {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .api-config h3 {
            font-size: 14px;
            color: #92400e;
            margin-bottom: 12px;
        }

        .instruction-box {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instruction-box h3 {
            font-size: 16px;
            color: #0c4a6e;
            margin-bottom: 8px;
        }

        .instruction-box p {
            font-size: 14px;
            color: #075985;
            line-height: 1.6;
        }

        .sensor-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
        }

        .sensor-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // メインアプリケーションコンポーネント
        const BuildingModelWorkbench = () => {
            const [currentView, setCurrentView] = useState('editor');
            const [buildingData, setBuildingData] = useState({
                building: { id: '', name: '', location: '', totalArea: 0 },
                floors: [],
                largeZones: [],
                smallZones: [],
                rooms: [],
                centralHVAC: { chillers: [], ahus: [], vavs: [] },
                individualHVAC: { vrfs: [] },
                sensors: []
            });
            const [physicalSensors, setPhysicalSensors] = useState([]);
            const [sensorMappings, setSensorMappings] = useState([]);
            const [matchingMode, setMatchingMode] = useState('regex'); // 'regex' or 'ai'
            const [chatMessages, setChatMessages] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [apiProvider, setApiProvider] = useState('openai');
            const [apiModel, setApiModel] = useState('gpt-4o-mini');
            const [apiEndpoint, setApiEndpoint] = useState('');
            const [queryPromptTemplate, setQueryPromptTemplate] = useState(`あなたは建物のセンサー情報を検索・分析するAIアシスタントです。

以下の建物データが提供されます：
<building_data>
{buildingData}
</building_data>

以下のセンサーマッピング情報が提供されます：
<sensor_mapping>
{sensorMappings}
</sensor_mapping>

ユーザーからの質問に基づいて、該当するセンサーを特定し、生成センサー（generated sensor）と対応する物理センサー（physical sensor）の情報を併記してJSON形式で回答してください。

処理手順：
1. ユーザーの質問を分析し、求められているセンサーの種類や設置場所を特定する
2. 建物データのsensorsリストから、質問に該当するセンサーを検索する（センサー名、タイプ、設置場所などを考慮）
3. 特定した各センサーについて、センサーマッピング情報から対応する物理センサーの情報を取得する
4. 結果をJSON形式で出力する

出力形式：
\`\`\`json
{
  "sensorlist": [
    {
      "generated": "生成センサー名（generatedSensorName）",
      "concrete": "物理センサー名（physicalSensorName）"
    }
  ]
}
\`\`\`

注意事項：
- センサーマッピング情報にない生成センサーの場合は、"concrete"フィールドに"マッピング情報なし"と記載してください
- 質問に該当するセンサーが複数ある場合は、すべてリストに含めてください
- センサー名は正確にデータから取得してください

質問：
{query}`);

            // サンプルデータのロード
            const loadSampleData = () => {
                const sample = {
                    building: {
                        id: 'Building_A',
                        name: '東京グリーンタワー',
                        location: '東京都千代田区',
                        totalArea: 2400
                    },
                    floors: [
                        { id: 'Floor_1', name: '1階', area: 1200 },
                        { id: 'Floor_2', name: '2階', area: 1200 }
                    ],
                    largeZones: [
                        { id: 'LargeZone_1A', name: '大ゾーン1A(東側エリア)', floorId: 'Floor_1', ahuId: 'AHU_1' },
                        { id: 'LargeZone_1B', name: '大ゾーン1B(西側エリア)', floorId: 'Floor_1', ahuId: 'AHU_1' },
                        { id: 'LargeZone_2A', name: '大ゾーン2A(全フロア)', floorId: 'Floor_2', ahuId: 'AHU_2' }
                    ],
                    smallZones: [
                        { id: 'SmallZone_1A1', name: '小ゾーン1A1(会議室エリア)', largeZoneId: 'LargeZone_1A', vrfId: 'VRF_Unit_1' },
                        { id: 'SmallZone_1A2', name: '小ゾーン1A2(オフィスエリア)', largeZoneId: 'LargeZone_1A', vrfId: 'VRF_Unit_1' },
                        { id: 'SmallZone_1B1', name: '小ゾーン1B1(執務室エリア)', largeZoneId: 'LargeZone_1B', vrfId: 'VRF_Unit_1' }
                    ],
                    rooms: [
                        { id: 'Room_101', name: '会議室101', smallZoneId: 'SmallZone_1A1', area: 30 },
                        { id: 'Room_102', name: '会議室102', smallZoneId: 'SmallZone_1A1', area: 30 },
                        { id: 'Room_103', name: 'オフィス103', smallZoneId: 'SmallZone_1A2', area: 50 }
                    ],
                    centralHVAC: {
                        chillers: [
                            { id: 'Chiller_1', name: 'チラー1号機', capacity: 150, powerRating: 50 }
                        ],
                        ahus: [
                            { id: 'AHU_1', name: '外調機1号機(1階担当)', chillerId: 'Chiller_1', airflow: 10000 },
                            { id: 'AHU_2', name: '外調機2号機(2階担当)', chillerId: 'Chiller_1', airflow: 8000 }
                        ],
                        vavs: [
                            { id: 'VAV_1A1', name: 'VAV 1A-1', ahuId: 'AHU_1', largeZoneId: 'LargeZone_1A' }
                        ]
                    },
                    individualHVAC: {
                        vrfs: [
                            { id: 'VRF_Unit_1', name: 'VRF室外機1号機', capacity: 40, powerRating: 15 }
                        ]
                    },
                    sensors: [
                        // 建物全体センサー (オントロジーベース命名規則: BLD:EntityID:Context:Type)
                        { id: 'BLD:Building_A:OUT:TEMP', name: '建物外気温度センサー', type: 'temperature', equipmentId: 'Building_A', unit: '°C' },
                        { id: 'BLD:Building_A:OUT:HUMD', name: '建物外気湿度センサー', type: 'humidity', equipmentId: 'Building_A', unit: '%RH' },
                        { id: 'BLD:Building_A:TOTAL:POWR', name: '建物総電力量センサー', type: 'power', equipmentId: 'Building_A', unit: 'kW' },

                        // チラー1号機センサー (CHL:EntityID:Context:Type)
                        { id: 'CHL:Chiller_1:SUP_WTR:TEMP', name: 'チラー1_送水温度センサー', type: 'temperature', equipmentId: 'Chiller_1', unit: '°C' },
                        { id: 'CHL:Chiller_1:RET_WTR:TEMP', name: 'チラー1_還水温度センサー', type: 'temperature', equipmentId: 'Chiller_1', unit: '°C' },
                        { id: 'CHL:Chiller_1:WTR_FLW:FLOW', name: 'チラー1_水流量センサー', type: 'flow', equipmentId: 'Chiller_1', unit: 'L/min' },
                        { id: 'CHL:Chiller_1:UNIT:POWR', name: 'チラー1_電力センサー', type: 'power', equipmentId: 'Chiller_1', unit: 'kW' },
                        { id: 'CHL:Chiller_1:UNIT:STAT', name: 'チラー1_運転状態センサー', type: 'status', equipmentId: 'Chiller_1', unit: 'on/off' },

                        // 外調機1号機センサー (AHU:EntityID:Context:Type)
                        { id: 'AHU:AHU_1:OUT:TEMP', name: '外調機1_外気温度センサー', type: 'temperature', equipmentId: 'AHU_1', unit: '°C' },
                        { id: 'AHU:AHU_1:OUT:HUMD', name: '外調機1_外気湿度センサー', type: 'humidity', equipmentId: 'AHU_1', unit: '%RH' },
                        { id: 'AHU:AHU_1:SUP_AIR:TEMP', name: '外調機1_給気温度センサー', type: 'temperature', equipmentId: 'AHU_1', unit: '°C' },
                        { id: 'AHU:AHU_1:SUP_AIR:HUMD', name: '外調機1_給気湿度センサー', type: 'humidity', equipmentId: 'AHU_1', unit: '%RH' },
                        { id: 'AHU:AHU_1:RET_AIR:TEMP', name: '外調機1_還気温度センサー', type: 'temperature', equipmentId: 'AHU_1', unit: '°C' },
                        { id: 'AHU:AHU_1:RET_AIR:HUMD', name: '外調機1_還気湿度センサー', type: 'humidity', equipmentId: 'AHU_1', unit: '%RH' },
                        { id: 'AHU:AHU_1:AIR_FLW:FLOW', name: '外調機1_給気風量センサー', type: 'flow', equipmentId: 'AHU_1', unit: 'm³/h' },
                        { id: 'AHU:AHU_1:DMPR:POS', name: '外調機1_ダンパー開度センサー', type: 'position', equipmentId: 'AHU_1', unit: '%' },
                        { id: 'AHU:AHU_1:FAN:SPD', name: '外調機1_ファン回転数センサー', type: 'speed', equipmentId: 'AHU_1', unit: 'rpm' },
                        { id: 'AHU:AHU_1:UNIT:POWR', name: '外調機1_電力センサー', type: 'power', equipmentId: 'AHU_1', unit: 'kW' },
                        { id: 'AHU:AHU_1:FLTR:PRES', name: '外調機1_フィルタ差圧センサー', type: 'pressure', equipmentId: 'AHU_1', unit: 'Pa' },

                        // 外調機2号機センサー (AHU:EntityID:Context:Type)
                        { id: 'AHU:AHU_2:OUT:TEMP', name: '外調機2_外気温度センサー', type: 'temperature', equipmentId: 'AHU_2', unit: '°C' },
                        { id: 'AHU:AHU_2:OUT:HUMD', name: '外調機2_外気湿度センサー', type: 'humidity', equipmentId: 'AHU_2', unit: '%RH' },
                        { id: 'AHU:AHU_2:SUP_AIR:TEMP', name: '外調機2_給気温度センサー', type: 'temperature', equipmentId: 'AHU_2', unit: '°C' },
                        { id: 'AHU:AHU_2:SUP_AIR:HUMD', name: '外調機2_給気湿度センサー', type: 'humidity', equipmentId: 'AHU_2', unit: '%RH' },
                        { id: 'AHU:AHU_2:RET_AIR:TEMP', name: '外調機2_還気温度センサー', type: 'temperature', equipmentId: 'AHU_2', unit: '°C' },
                        { id: 'AHU:AHU_2:RET_AIR:HUMD', name: '外調機2_還気湿度センサー', type: 'humidity', equipmentId: 'AHU_2', unit: '%RH' },
                        { id: 'AHU:AHU_2:AIR_FLW:FLOW', name: '外調機2_給気風量センサー', type: 'flow', equipmentId: 'AHU_2', unit: 'm³/h' },
                        { id: 'AHU:AHU_2:DMPR:POS', name: '外調機2_ダンパー開度センサー', type: 'position', equipmentId: 'AHU_2', unit: '%' },
                        { id: 'AHU:AHU_2:FAN:SPD', name: '外調機2_ファン回転数センサー', type: 'speed', equipmentId: 'AHU_2', unit: 'rpm' },
                        { id: 'AHU:AHU_2:UNIT:POWR', name: '外調機2_電力センサー', type: 'power', equipmentId: 'AHU_2', unit: 'kW' },
                        { id: 'AHU:AHU_2:FLTR:PRES', name: '外調機2_フィルタ差圧センサー', type: 'pressure', equipmentId: 'AHU_2', unit: 'Pa' },

                        // VAVセンサー (VAV:EntityID:Context:Type)
                        { id: 'VAV:VAV_1A1:SUP_AIR:TEMP', name: 'VAV1A-1_給気温度センサー', type: 'temperature', equipmentId: 'VAV_1A1', unit: '°C' },
                        { id: 'VAV:VAV_1A1:DMPR:POS', name: 'VAV1A-1_ダンパー開度センサー', type: 'position', equipmentId: 'VAV_1A1', unit: '%' },
                        { id: 'VAV:VAV_1A1:AIR_FLW:FLOW', name: 'VAV1A-1_風量センサー', type: 'flow', equipmentId: 'VAV_1A1', unit: 'm³/h' },

                        // VRF室外機センサー (VRF:EntityID:Context:Type)
                        { id: 'VRF:VRF_Unit_1:OUT:TEMP', name: 'VRF1_室外機温度センサー', type: 'temperature', equipmentId: 'VRF_Unit_1', unit: '°C' },
                        { id: 'VRF:VRF_Unit_1:UNIT:POWR', name: 'VRF1_電力センサー', type: 'power', equipmentId: 'VRF_Unit_1', unit: 'kW' },
                        { id: 'VRF:VRF_Unit_1:UNIT:STAT', name: 'VRF1_運転状態センサー', type: 'status', equipmentId: 'VRF_Unit_1', unit: 'on/off' },
                        { id: 'VRF:VRF_Unit_1:COMP:FREQ', name: 'VRF1_圧縮機周波数センサー', type: 'frequency', equipmentId: 'VRF_Unit_1', unit: 'Hz' },

                        // 大ゾーンセンサー (LZN:EntityID:Context:Type)
                        { id: 'LZN:LargeZone_1A:AMB:TEMP', name: '大ゾーン1A_温度センサー', type: 'temperature', equipmentId: 'LargeZone_1A', unit: '°C' },
                        { id: 'LZN:LargeZone_1A:AMB:HUMD', name: '大ゾーン1A_湿度センサー', type: 'humidity', equipmentId: 'LargeZone_1A', unit: '%RH' },
                        { id: 'LZN:LargeZone_1B:AMB:TEMP', name: '大ゾーン1B_温度センサー', type: 'temperature', equipmentId: 'LargeZone_1B', unit: '°C' },
                        { id: 'LZN:LargeZone_1B:AMB:HUMD', name: '大ゾーン1B_湿度センサー', type: 'humidity', equipmentId: 'LargeZone_1B', unit: '%RH' },
                        { id: 'LZN:LargeZone_2A:AMB:TEMP', name: '大ゾーン2A_温度センサー', type: 'temperature', equipmentId: 'LargeZone_2A', unit: '°C' },
                        { id: 'LZN:LargeZone_2A:AMB:HUMD', name: '大ゾーン2A_湿度センサー', type: 'humidity', equipmentId: 'LargeZone_2A', unit: '%RH' },

                        // 小ゾーンセンサー (SZN:EntityID:Context:Type)
                        { id: 'SZN:SmallZone_1A1:AMB:TEMP', name: '小ゾーン1A1_温度センサー', type: 'temperature', equipmentId: 'SmallZone_1A1', unit: '°C' },
                        { id: 'SZN:SmallZone_1A1:AMB:HUMD', name: '小ゾーン1A1_湿度センサー', type: 'humidity', equipmentId: 'SmallZone_1A1', unit: '%RH' },
                        { id: 'SZN:SmallZone_1A2:AMB:TEMP', name: '小ゾーン1A2_温度センサー', type: 'temperature', equipmentId: 'SmallZone_1A2', unit: '°C' },
                        { id: 'SZN:SmallZone_1A2:AMB:HUMD', name: '小ゾーン1A2_湿度センサー', type: 'humidity', equipmentId: 'SmallZone_1A2', unit: '%RH' },
                        { id: 'SZN:SmallZone_1B1:AMB:TEMP', name: '小ゾーン1B1_温度センサー', type: 'temperature', equipmentId: 'SmallZone_1B1', unit: '°C' },
                        { id: 'SZN:SmallZone_1B1:AMB:HUMD', name: '小ゾーン1B1_湿度センサー', type: 'humidity', equipmentId: 'SmallZone_1B1', unit: '%RH' },

                        // 部屋センサー (ROM:EntityID:Context:Type)
                        { id: 'ROM:Room_101:AMB:TEMP', name: '会議室101_室温センサー', type: 'temperature', equipmentId: 'Room_101', unit: '°C' },
                        { id: 'ROM:Room_101:AMB:HUMD', name: '会議室101_湿度センサー', type: 'humidity', equipmentId: 'Room_101', unit: '%RH' },
                        { id: 'ROM:Room_101:AMB:CO2', name: '会議室101_CO2センサー', type: 'co2', equipmentId: 'Room_101', unit: 'ppm' },
                        { id: 'ROM:Room_101:AMB:OCCP', name: '会議室101_在室センサー', type: 'occupancy', equipmentId: 'Room_101', unit: 'persons' },
                        { id: 'ROM:Room_101:AMB:ILLM', name: '会議室101_照度センサー', type: 'illuminance', equipmentId: 'Room_101', unit: 'lx' },

                        { id: 'ROM:Room_102:AMB:TEMP', name: '会議室102_室温センサー', type: 'temperature', equipmentId: 'Room_102', unit: '°C' },
                        { id: 'ROM:Room_102:AMB:HUMD', name: '会議室102_湿度センサー', type: 'humidity', equipmentId: 'Room_102', unit: '%RH' },
                        { id: 'ROM:Room_102:AMB:CO2', name: '会議室102_CO2センサー', type: 'co2', equipmentId: 'Room_102', unit: 'ppm' },
                        { id: 'ROM:Room_102:AMB:OCCP', name: '会議室102_在室センサー', type: 'occupancy', equipmentId: 'Room_102', unit: 'persons' },
                        { id: 'ROM:Room_102:AMB:ILLM', name: '会議室102_照度センサー', type: 'illuminance', equipmentId: 'Room_102', unit: 'lx' },

                        { id: 'ROM:Room_103:AMB:TEMP', name: 'オフィス103_室温センサー', type: 'temperature', equipmentId: 'Room_103', unit: '°C' },
                        { id: 'ROM:Room_103:AMB:HUMD', name: 'オフィス103_湿度センサー', type: 'humidity', equipmentId: 'Room_103', unit: '%RH' },
                        { id: 'ROM:Room_103:AMB:CO2', name: 'オフィス103_CO2センサー', type: 'co2', equipmentId: 'Room_103', unit: 'ppm' },
                        { id: 'ROM:Room_103:AMB:OCCP', name: 'オフィス103_在室センサー', type: 'occupancy', equipmentId: 'Room_103', unit: 'persons' },
                        { id: 'ROM:Room_103:AMB:ILLM', name: 'オフィス103_照度センサー', type: 'illuminance', equipmentId: 'Room_103', unit: 'lx' }
                    ]
                };
                setBuildingData(sample);
                alert('サンプルデータを読み込みました');
            };

            // JSONエクスポート
            const exportJSON = () => {
                const dataStr = JSON.stringify(buildingData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `building_data_${buildingData.building.id}.json`;
                link.click();
            };

            // JSONインポート
            const importJSON = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            setBuildingData(data);
                            alert('JSONデータを読み込みました');
                        } catch (error) {
                            alert('JSONファイルの読み込みに失敗しました');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // CSVインポート（具体センサー）
            const importPhysicalSensorsCSV = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        const headers = lines[0].split(',');
                        const sensors = lines.slice(1).map(line => {
                            const values = line.split(',');
                            return {
                                id: values[0]?.trim(),
                                name: values[1]?.trim(),
                                type: values[2]?.trim(),
                                location: values[3]?.trim(),
                                unit: values[4]?.trim()
                            };
                        }).filter(s => s.id);
                        setPhysicalSensors(sensors);
                        alert(`${sensors.length}個の具体センサーを読み込みました`);
                    };
                    reader.readAsText(file);
                }
            };

            // センサータイプマッピング（物理センサータイプ → オントロジータイプコード）
            const SENSOR_TYPE_MAPPING = {
                'temperature': 'TEMP',
                'humidity': 'HUMD',
                'power': 'POWR',
                'flow': 'FLOW',
                'pressure': 'PRES',
                'position': 'POS',
                'speed': 'SPD',
                'frequency': 'FREQ',
                'status': 'STAT',
                'co2': 'CO2',
                'occupancy': 'OCCP',
                'illuminance': 'ILLM'
            };

            // 測定コンテキストキーワード
            const MEASUREMENT_CONTEXT_KEYWORDS = {
                'OUT': ['outdoor', 'outside', '外気', '屋外'],
                'SUP_AIR': ['supply air', 'supply', '給気', 'SA'],
                'RET_AIR': ['return air', 'return', '還気', 'RA'],
                'SUP_WTR': ['supply water', 'chilled water supply', '冷水供給', '往き'],
                'RET_WTR': ['return water', 'chilled water return', '冷水還り', '戻り'],
                'AIR_FLW': ['air flow', '風量'],
                'WTR_FLW': ['water flow', '水流量'],
                'DMPR': ['damper', 'ダンパー'],
                'FAN': ['fan', 'ファン'],
                'FLTR': ['filter', 'フィルター'],
                'COMP': ['compressor', '圧縮機'],
                'AMB': ['ambient', 'room', 'zone', '室内', '環境'],
                'UNIT': ['unit', 'equipment', '機器'],
                'TOTAL': ['total', '合計', '全体']
            };

            // エンティティタイプキーワード
            const ENTITY_TYPE_KEYWORDS = {
                'BLD': ['building', '建物'],
                'FLR': ['floor', '階'],
                'LZN': ['large zone', 'largezone', 'ラージゾーン'],
                'SZN': ['small zone', 'smallzone', 'スモールゾーン'],
                'ROM': ['room', '部屋'],
                'CHL': ['chiller', 'チラー'],
                'AHU': ['ahu', 'air handling unit', 'エアハンドリングユニット'],
                'VAV': ['vav', 'variable air volume'],
                'VRF': ['vrf', 'variable refrigerant flow']
            };

            // エンティティID抽出パターン
            const ENTITY_ID_PATTERNS = [
                { pattern: /Building[_\s]?([A-Za-z0-9]+)/i, type: 'BLD' },
                { pattern: /Floor[_\s]?(\d+)/i, type: 'FLR' },
                { pattern: /LargeZone[_\s]?([A-Za-z0-9]+)/i, type: 'LZN' },
                { pattern: /SmallZone[_\s]?([A-Za-z0-9]+)/i, type: 'SZN' },
                { pattern: /Room[_\s]?(\d+)/i, type: 'ROM' },
                { pattern: /Chiller[_\s]?(\d+)/i, type: 'CHL' },
                { pattern: /AHU[_\s]?(\d+)/i, type: 'AHU' },
                { pattern: /VAV[_\s]?([A-Za-z0-9]+)/i, type: 'VAV' },
                { pattern: /VRF[_\s]?Unit[_\s]?(\d+)/i, type: 'VRF' }
            ];

            // 階層情報の動的生成
            const generateHierarchyData = (buildingData) => {
                const lines = [];

                // 建物階層
                lines.push(`■ 空間階層:`);
                lines.push(`Building: ${buildingData.building.id} (${buildingData.building.name})`);

                buildingData.floors.forEach(floor => {
                    lines.push(`  └─ Floor: ${floor.id} (${floor.name})`);

                    // LargeZoneの取得
                    buildingData.largeZones
                        .filter(lz => lz.floorId === floor.id)
                        .forEach(lz => {
                            lines.push(`      └─ LargeZone: ${lz.id} (${lz.name})`);

                            // SmallZoneの取得
                            buildingData.smallZones
                                .filter(sz => sz.largeZoneId === lz.id)
                                .forEach(sz => {
                                    lines.push(`          └─ SmallZone: ${sz.id} (${sz.name})`);

                                    // Roomの取得
                                    buildingData.rooms
                                        .filter(room => room.smallZoneId === sz.id)
                                        .forEach(room => {
                                            lines.push(`              └─ Room: ${room.id} (${room.name})`);
                                        });
                                });
                        });
                });

                lines.push(``);
                lines.push(`■ 設備階層:`);

                // Chiller階層
                buildingData.centralHVAC.chillers.forEach(chiller => {
                    lines.push(`Chiller: ${chiller.id}`);

                    // ChillerのAHU接続
                    buildingData.centralHVAC.ahus
                        .filter(ahu => ahu.chillerId === chiller.id)
                        .forEach(ahu => {
                            lines.push(`  └─ AHU: ${ahu.id}`);

                            // AHUのVAV接続
                            buildingData.centralHVAC.vavs
                                .filter(vav => vav.ahuId === ahu.id)
                                .forEach(vav => {
                                    const lz = buildingData.largeZones.find(z => z.id === vav.servedZoneId);
                                    lines.push(`      └─ VAV: ${vav.id} → LargeZone: ${vav.servedZoneId}${lz ? ' ('+lz.name+')' : ''}`);
                                });
                        });
                });

                // VRF階層
                buildingData.individualHVAC.vrfs.forEach(vrf => {
                    lines.push(`VRF: ${vrf.id}`);
                    vrf.servedZoneIds.forEach(zoneId => {
                        const sz = buildingData.smallZones.find(z => z.id === zoneId);
                        lines.push(`  └─ SmallZone: ${zoneId}${sz ? ' ('+sz.name+')' : ''}`);
                    });
                });

                return lines.join('\n');
            };

            // 正規表現ベースのマッチング
            const regexBasedMatching = (generatedSensor, physicalSensor) => {
                const genId = generatedSensor.id;
                const physName = physicalSensor.name.toLowerCase();
                const physLocation = (physicalSensor.location || '').toLowerCase();
                const combinedText = `${physName} ${physLocation}`;

                // 生成センサーIDの分解: EntityType:EntityID:Context:SensorType
                const parts = genId.split(':');
                if (parts.length !== 4) return { score: 0, details: {} };

                const [entityType, entityId, context, sensorType] = parts;

                let score = 0;
                const details = {};

                // 1. エンティティIDマッチング (40%)
                const entityIdLower = entityId.toLowerCase().replace(/_/g, ' ');
                if (combinedText.includes(entityIdLower)) {
                    score += 0.4;
                    details.entityIdMatch = true;
                } else {
                    // 部分マッチ
                    const words = entityIdLower.split(' ');
                    const matchedWords = words.filter(w => combinedText.includes(w));
                    const partialScore = (matchedWords.length / words.length) * 0.4;
                    score += partialScore;
                    details.entityIdMatch = partialScore > 0;
                    details.entityIdPartial = partialScore;
                }

                // 2. エンティティタイプマッチング (25%)
                const typeKeywords = ENTITY_TYPE_KEYWORDS[entityType] || [];
                if (typeKeywords.some(kw => combinedText.includes(kw.toLowerCase()))) {
                    score += 0.25;
                    details.entityTypeMatch = true;
                }

                // 3. 測定コンテキストマッチング (25%)
                const contextKeywords = MEASUREMENT_CONTEXT_KEYWORDS[context] || [];
                if (contextKeywords.some(kw => combinedText.includes(kw.toLowerCase()))) {
                    score += 0.25;
                    details.contextMatch = true;
                }

                // 4. センサータイプマッチング (基本確認)
                const expectedSensorType = SENSOR_TYPE_MAPPING[physicalSensor.type];
                if (expectedSensorType === sensorType) {
                    details.sensorTypeMatch = true;
                } else {
                    // タイプが一致しない場合はスコアを大幅に減点
                    score *= 0.3;
                    details.sensorTypeMatch = false;
                }

                // 5. ボーナスキーワードマッチング (最大10%)
                const bonusKeywords = [entityId.toLowerCase(), ...contextKeywords];
                const bonusMatches = bonusKeywords.filter(kw => combinedText.includes(kw.toLowerCase())).length;
                const bonusScore = Math.min(0.1, bonusMatches * 0.02);
                score += bonusScore;
                details.bonusScore = bonusScore;

                return { score, details };
            };

            // AIベースのマッチング
            const aiBasedMatching = async (generatedSensors, physicalSensors, buildingData) => {
                if (!apiKey) {
                    throw new Error('API設定でAPIキーを入力してください');
                }

                // 階層情報の動的生成
                const hierarchyData = generateHierarchyData(buildingData);

                // AIマッチング用プロンプト構築
                const systemPrompt = `あなたは建物管理システムのセンサーマッチング専門家です。

## センサー命名規則

オントロジーベースのセンサーIDフォーマット:
\`{EntityType}:{EntityID}:{MeasurementContext}:{SensorType}\`

### EntityType (エンティティタイプ)
- BLD: Building (建物)
- FLR: Floor (階)
- LZN: LargeZone (ラージゾーン)
- SZN: SmallZone (スモールゾーン)
- ROM: Room (部屋)
- CHL: Chiller (チラー)
- AHU: Air Handling Unit (エアハンドリングユニット)
- VAV: Variable Air Volume (変風量ユニット)
- VRF: Variable Refrigerant Flow (可変冷媒流量システム)

### MeasurementContext (測定コンテキスト)
- OUT: 外気・屋外
- SUP_AIR: 給気
- RET_AIR: 還気
- SUP_WTR: 供給水
- RET_WTR: 還水
- AIR_FLW: 風量
- WTR_FLW: 水流量
- DMPR: ダンパー
- FAN: ファン
- FLTR: フィルター
- COMP: 圧縮機
- AMB: 環境・室内
- UNIT: 機器全体
- TOTAL: 合計・全体

### SensorType (センサータイプ)
- TEMP: 温度
- HUMD: 湿度
- POWR: 電力
- FLOW: 流量
- PRES: 圧力
- POS: 位置
- SPD: 速度
- FREQ: 周波数
- STAT: 状態
- CO2: CO2濃度
- OCCP: 在室
- ILLM: 照度

## 建物階層構造

${hierarchyData}

## タスク

以下の生成センサー（論理センサー）と物理センサー（実センサー）のリストを元に、最適なマッピングを行ってください。

各生成センサーに対して、最も適合する物理センサーを特定し、信頼度スコア（0.0〜1.0）を付与してください。

### 生成センサーリスト:
${JSON.stringify(generatedSensors, null, 2)}

### 物理センサーリスト:
${JSON.stringify(physicalSensors, null, 2)}

## 出力形式

以下のJSON形式で出力してください:

\`\`\`json
{
  "mappings": [
    {
      "generatedSensorId": "BLD:Building_A:OUT:TEMP",
      "physicalSensorId": "OAT_001",
      "confidence": 0.95,
      "reason": "建物外気温度センサーとして、位置とタイプが完全一致"
    }
  ]
}
\`\`\`

必ず信頼度0.5以上のマッピングのみを出力してください。`;

                try {
                    const response = await callActualAPI(systemPrompt, apiProvider, apiModel, apiEndpoint, apiKey);

                    // JSONレスポンスのパース
                    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/) || response.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('AIのレスポンスからJSON形式のマッピング結果を抽出できませんでした');
                    }

                    const jsonText = jsonMatch[1] || jsonMatch[0];
                    const result = JSON.parse(jsonText);

                    return result.mappings || [];
                } catch (error) {
                    console.error('AI Matching Error:', error);
                    throw error;
                }
            };

            // センサーマッピング実行
            const performSensorMapping = async () => {
                if (physicalSensors.length === 0) {
                    alert('具体センサーCSVをインポートしてください');
                    return;
                }

                if (buildingData.sensors.length === 0) {
                    alert('建物エディタでセンサーを追加してください');
                    return;
                }

                try {
                    let mappings = [];

                    if (matchingMode === 'regex') {
                        // 正規表現ベースのマッチング
                        const allMatches = [];
                        buildingData.sensors.forEach(genSensor => {
                            physicalSensors.forEach(physSensor => {
                                const result = regexBasedMatching(genSensor, physSensor);
                                if (result.score > 0.5) {
                                    allMatches.push({
                                        generatedSensorId: genSensor.id,
                                        generatedSensorName: genSensor.name,
                                        physicalSensorId: physSensor.id,
                                        physicalSensorName: physSensor.name,
                                        confidence: result.score,
                                        reason: `正規表現マッチング: スコア ${(result.score * 100).toFixed(0)}% (${
                                            Object.keys(result.details).filter(k => result.details[k] === true).join(', ')
                                        })`
                                    });
                                }
                            });
                        });

                        // 各生成センサーに対して最も信頼度の高いマッピングのみを残す
                        const bestMappings = {};
                        allMatches.forEach(mapping => {
                            const key = mapping.generatedSensorId;
                            if (!bestMappings[key] || bestMappings[key].confidence < mapping.confidence) {
                                bestMappings[key] = mapping;
                            }
                        });

                        mappings = Object.values(bestMappings);
                        setSensorMappings(mappings);
                        alert(`正規表現マッチングで${mappings.length}個のマッピングを生成しました`);

                    } else if (matchingMode === 'ai') {
                        // AIベースのマッチング
                        if (!apiKey) {
                            alert('AI マッチングにはAPI設定でAPIキーを入力してください');
                            return;
                        }

                        const aiMappings = await aiBasedMatching(buildingData.sensors, physicalSensors, buildingData);

                        // AIの結果を表示形式に変換
                        mappings = aiMappings.map(m => {
                            const genSensor = buildingData.sensors.find(s => s.id === m.generatedSensorId);
                            const physSensor = physicalSensors.find(s => s.id === m.physicalSensorId);
                            return {
                                generatedSensorId: m.generatedSensorId,
                                generatedSensorName: genSensor ? genSensor.name : m.generatedSensorId,
                                physicalSensorId: m.physicalSensorId,
                                physicalSensorName: physSensor ? physSensor.name : m.physicalSensorId,
                                confidence: m.confidence,
                                reason: m.reason || 'AIマッチング'
                            };
                        });

                        setSensorMappings(mappings);
                        alert(`AI マッチングで${mappings.length}個のマッピングを生成しました`);
                    }
                } catch (error) {
                    alert(`マッピングエラー: ${error.message}`);
                    console.error('Mapping Error:', error);
                }
            };

            // 簡易的な文字列類似度計算
            const calculateSimilarity = (str1, str2) => {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;

                if (longer.length === 0) return 1.0;

                let matches = 0;
                for (let i = 0; i < shorter.length; i++) {
                    if (longer.includes(shorter[i])) matches++;
                }

                return matches / longer.length;
            };

            // バックエンドサーバー経由でAI API呼び出し
            const callActualAPI = async (prompt, provider, model, endpoint, key) => {
                try {
                    // バックエンドサーバーのURL（デフォルトはlocalhost:3001）
                    const backendURL = window.location.origin;
                    const proxyEndpoint = `${backendURL}/api/${provider}`;

                    console.log(`Calling backend proxy: ${proxyEndpoint}`);

                    const response = await fetch(proxyEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            apiKey: key,
                            model: model,
                            prompt: prompt,
                            endpoint: endpoint || undefined
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || data.message || 'API Error');
                    }

                    return data.content;
                } catch (error) {
                    // ネットワークエラーやサーバー接続エラーの詳細表示
                    if (error.message.includes('Failed to fetch')) {
                        throw new Error('バックエンドサーバーに接続できません。サーバーが起動しているか確認してください。(http://localhost:3001)');
                    }
                    throw error;
                }
            };

            // チャット送信
            const sendChatMessage = async (message) => {
                if (!message.trim()) return;

                // ユーザーメッセージを追加
                const userMessage = { role: 'user', content: message };
                setChatMessages(prev => [...prev, userMessage]);

                // プロンプトテンプレートに変数を埋め込んで実際のプロンプトを生成
                const actualPrompt = queryPromptTemplate
                    .replace('{buildingData}', JSON.stringify(buildingData, null, 2))
                    .replace('{sensorMappings}', JSON.stringify(sensorMappings, null, 2))
                    .replace('{query}', message);

                const isAPIMode = !!apiKey;
                const actualEndpoint = apiEndpoint || getDefaultEndpoint(apiProvider);

                // デバッグ情報を準備
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    provider: apiProvider,
                    model: apiModel,
                    endpoint: actualEndpoint,
                    hasApiKey: isAPIMode,
                    promptTemplate: queryPromptTemplate,
                    actualPrompt: actualPrompt,
                    buildingDataSize: JSON.stringify(buildingData).length,
                    sensorMappingsCount: sensorMappings.length,
                    mode: isAPIMode ? 'API Mode (実際のAI API使用)' : 'Simulation Mode (ダミー応答)'
                };

                // AIレスポンス取得
                if (isAPIMode) {
                    // 実際のAPI呼び出し
                    try {
                        const response = await callActualAPI(actualPrompt, apiProvider, apiModel, actualEndpoint, apiKey);

                        // デバッグ情報にレスポンスを追加
                        const debugInfoWithResponse = {
                            ...debugInfo,
                            rawResponse: response,
                            responseLength: response.length,
                            responseTime: new Date().toISOString(),
                            apiCallSuccess: true
                        };

                        const assistantMessage = {
                            role: 'assistant',
                            content: response,
                            debug: debugInfoWithResponse
                        };
                        setChatMessages(prev => [...prev, assistantMessage]);
                    } catch (error) {
                        // APIエラー時
                        let errorMessage = `❌ API呼び出しエラー: ${error.message}\n\n`;
                        let isServerError = false;

                        // バックエンドサーバー接続エラーの検出
                        if (error.message.includes('バックエンドサーバーに接続できません')) {
                            isServerError = true;
                            errorMessage += `🔌 バックエンドサーバーが起動していない可能性があります。\n\n`;
                            errorMessage += `解決方法:\n`;
                            errorMessage += `1. ターミナルを開く\n`;
                            errorMessage += `2. workbenchディレクトリに移動: cd workbench\n`;
                            errorMessage += `3. npm install で依存パッケージをインストール（初回のみ）\n`;
                            errorMessage += `4. npm start でサーバーを起動\n`;
                            errorMessage += `5. http://localhost:3001/building_model_workbench.html でアクセス\n\n`;
                            errorMessage += `詳細は README_SERVER.md を参照してください。\n`;
                        } else {
                            errorMessage += `プロバイダー: ${apiProvider}\n`;
                            errorMessage += `モデル: ${apiModel}\n`;
                            errorMessage += `バックエンドURL: ${window.location.origin}/api/${apiProvider}\n\n`;
                            errorMessage += `考えられる原因:\n`;
                            errorMessage += `- APIキーが正しくない\n`;
                            errorMessage += `- モデル名が正しくない\n`;
                            errorMessage += `- API利用制限に達している\n`;
                            errorMessage += `- ネットワーク接続の問題\n`;
                        }

                        const debugInfoWithError = {
                            ...debugInfo,
                            rawResponse: errorMessage,
                            responseLength: errorMessage.length,
                            responseTime: new Date().toISOString(),
                            apiCallSuccess: false,
                            errorMessage: error.message,
                            isServerError: isServerError,
                            errorType: error.name
                        };

                        const assistantMessage = {
                            role: 'assistant',
                            content: errorMessage,
                            debug: debugInfoWithError
                        };
                        setChatMessages(prev => [...prev, assistantMessage]);
                    }
                } else {
                    // シミュレーションモード
                    setTimeout(() => {
                        const response = generateAIResponse(message, buildingData, sensorMappings);

                        const debugInfoWithResponse = {
                            ...debugInfo,
                            rawResponse: response,
                            responseLength: response.length,
                            responseTime: new Date().toISOString(),
                            apiCallSuccess: false,
                            simulationNote: 'APIキーが設定されていないためダミー応答を返しています'
                        };

                        const assistantMessage = {
                            role: 'assistant',
                            content: response,
                            debug: debugInfoWithResponse
                        };
                        setChatMessages(prev => [...prev, assistantMessage]);
                    }, 500);
                }
            };

            // デフォルトエンドポイント取得関数
            const getDefaultEndpoint = (provider) => {
                switch (provider) {
                    case 'openai':
                        return 'https://api.openai.com/v1';
                    case 'anthropic':
                        return 'https://api.anthropic.com/v1';
                    case 'google':
                        return 'https://generativelanguage.googleapis.com/v1';
                    default:
                        return '';
                }
            };

            // AI応答生成（シミュレーション）
            const generateAIResponse = (query, data, mappings) => {
                const lowerQuery = query.toLowerCase();

                // 温度センサーの検索
                if (lowerQuery.includes('温度') || lowerQuery.includes('気温')) {
                    const tempSensors = data.sensors.filter(s => s.type === 'temperature');
                    if (tempSensors.length > 0) {
                        let response = `${tempSensors.length}個の温度センサーが見つかりました:\\n\\n`;
                        tempSensors.forEach(sensor => {
                            response += `- ${sensor.name} (ID: ${sensor.id})\\n`;
                            const mapping = mappings.find(m => m.generatedSensorId === sensor.id);
                            if (mapping) {
                                response += `  → 具体センサー: ${mapping.physicalSensorName} (信頼度: ${(mapping.confidence * 100).toFixed(0)}%)\\n`;
                            }
                        });
                        return response;
                    }
                }

                // 会議室の検索
                if (lowerQuery.includes('会議室')) {
                    const meetingRooms = data.rooms.filter(r => r.name.includes('会議室'));
                    if (meetingRooms.length > 0) {
                        let response = `${meetingRooms.length}個の会議室が見つかりました:\\n\\n`;
                        meetingRooms.forEach(room => {
                            response += `- ${room.name} (ID: ${room.id})\\n`;
                            const roomSensors = data.sensors.filter(s => s.equipmentId === room.id);
                            if (roomSensors.length > 0) {
                                response += `  センサー: ${roomSensors.map(s => s.name).join(', ')}\\n`;
                            }
                        });
                        return response;
                    }
                }

                // デフォルトレスポンス
                return `申し訳ございません。「${query}」に関する情報が見つかりませんでした。\\n\\n以下のような質問をお試しください:\\n- 「会議室の温度センサーを教えて」\\n- 「1階のセンサー一覧」\\n- 「外調機のセンサー」`;
            };

            // ビューコンポーネント
            const renderView = () => {
                switch (currentView) {
                    case 'editor':
                        return <BuildingEditor data={buildingData} setData={setBuildingData} />;
                    case 'mapping':
                        return <SensorMapping
                            generatedSensors={buildingData.sensors}
                            physicalSensors={physicalSensors}
                            mappings={sensorMappings}
                            onImportCSV={importPhysicalSensorsCSV}
                            onPerformMapping={performSensorMapping}
                            matchingMode={matchingMode}
                            onMatchingModeChange={setMatchingMode}
                        />;
                    case 'chat':
                        return <ChatInterface
                            messages={chatMessages}
                            onSendMessage={sendChatMessage}
                            promptTemplate={queryPromptTemplate}
                            setPromptTemplate={setQueryPromptTemplate}
                            buildingData={buildingData}
                            sensorMappings={sensorMappings}
                        />;
                    case 'settings':
                        return <Settings
                            apiKey={apiKey}
                            setApiKey={setApiKey}
                            apiProvider={apiProvider}
                            setApiProvider={setApiProvider}
                            apiModel={apiModel}
                            setApiModel={setApiModel}
                            apiEndpoint={apiEndpoint}
                            setApiEndpoint={setApiEndpoint}
                        />;
                    default:
                        return <div>未実装</div>;
                }
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>建物モデルワークベンチ</h1>
                        <p>Building Model Workbench - 統合建物情報管理システム</p>
                    </div>

                    <div className="main-content">
                        <div className="sidebar">
                            <div className="sidebar-section">
                                <h3>ナビゲーション</h3>
                                <button
                                    className={`nav-button ${currentView === 'editor' ? 'active' : ''}`}
                                    onClick={() => setCurrentView('editor')}
                                >
                                    📝 建物モデルエディタ
                                </button>
                                <button
                                    className={`nav-button ${currentView === 'mapping' ? 'active' : ''}`}
                                    onClick={() => setCurrentView('mapping')}
                                >
                                    🔗 センサーマッピング
                                </button>
                                <button
                                    className={`nav-button ${currentView === 'chat' ? 'active' : ''}`}
                                    onClick={() => setCurrentView('chat')}
                                >
                                    💬 自然言語クエリ
                                </button>
                                <button
                                    className={`nav-button ${currentView === 'settings' ? 'active' : ''}`}
                                    onClick={() => setCurrentView('settings')}
                                >
                                    ⚙️ API設定
                                </button>
                            </div>

                            <div className="sidebar-section">
                                <h3>データ管理</h3>
                                <button className="nav-button" onClick={loadSampleData}>
                                    📋 サンプルデータ読込
                                </button>
                                <button className="nav-button" onClick={exportJSON}>
                                    💾 JSONエクスポート
                                </button>
                                <label className="nav-button" style={{cursor: 'pointer'}}>
                                    📂 JSONインポート
                                    <input type="file" accept=".json" onChange={importJSON} />
                                </label>
                            </div>

                            <div className="sidebar-section" style={{marginTop: 'auto'}}>
                                <div className="stats-grid" style={{gridTemplateColumns: '1fr'}}>
                                    <div className="stat-card">
                                        <h3>センサー数</h3>
                                        <div className="value">{buildingData.sensors.length}</div>
                                    </div>
                                    <div className="stat-card">
                                        <h3>マッピング数</h3>
                                        <div className="value">{sensorMappings.length}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="workspace">
                            {renderView()}
                        </div>
                    </div>
                </div>
            );
        };

        // 建物エディタコンポーネント（全機能）
        const BuildingEditor = ({ data, setData }) => {
            const [activeTab, setActiveTab] = useState('building');

            // 建物情報の更新
            const updateBuilding = (field, value) => {
                setData(prev => ({
                    ...prev,
                    building: { ...prev.building, [field]: value }
                }));
            };

            // 階の操作
            const addFloor = () => {
                setData(prev => ({
                    ...prev,
                    floors: [...prev.floors, { id: '', name: '', area: 0 }]
                }));
            };

            const updateFloor = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    floors: prev.floors.map((floor, i) =>
                        i === index ? { ...floor, [field]: value } : floor
                    )
                }));
            };

            const deleteFloor = (index) => {
                setData(prev => ({
                    ...prev,
                    floors: prev.floors.filter((_, i) => i !== index)
                }));
            };

            // 大ゾーンの操作
            const addLargeZone = () => {
                setData(prev => ({
                    ...prev,
                    largeZones: [...prev.largeZones, { id: '', name: '', floorId: '', ahuId: '' }]
                }));
            };

            const updateLargeZone = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    largeZones: prev.largeZones.map((zone, i) =>
                        i === index ? { ...zone, [field]: value } : zone
                    )
                }));
            };

            const deleteLargeZone = (index) => {
                setData(prev => ({
                    ...prev,
                    largeZones: prev.largeZones.filter((_, i) => i !== index)
                }));
            };

            // 小ゾーンの操作
            const addSmallZone = () => {
                setData(prev => ({
                    ...prev,
                    smallZones: [...prev.smallZones, { id: '', name: '', largeZoneId: '', vrfId: '' }]
                }));
            };

            const updateSmallZone = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    smallZones: prev.smallZones.map((zone, i) =>
                        i === index ? { ...zone, [field]: value } : zone
                    )
                }));
            };

            const deleteSmallZone = (index) => {
                setData(prev => ({
                    ...prev,
                    smallZones: prev.smallZones.filter((_, i) => i !== index)
                }));
            };

            // 部屋の操作
            const addRoom = () => {
                setData(prev => ({
                    ...prev,
                    rooms: [...prev.rooms, { id: '', name: '', smallZoneId: '', area: 0 }]
                }));
            };

            const updateRoom = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    rooms: prev.rooms.map((room, i) =>
                        i === index ? { ...room, [field]: value } : room
                    )
                }));
            };

            const deleteRoom = (index) => {
                setData(prev => ({
                    ...prev,
                    rooms: prev.rooms.filter((_, i) => i !== index)
                }));
            };

            // チラーの操作
            const addChiller = () => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        chillers: [...prev.centralHVAC.chillers, { id: '', name: '', capacity: 0, powerRating: 0 }]
                    }
                }));
            };

            const updateChiller = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        chillers: prev.centralHVAC.chillers.map((chiller, i) =>
                            i === index ? { ...chiller, [field]: value } : chiller
                        )
                    }
                }));
            };

            const deleteChiller = (index) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        chillers: prev.centralHVAC.chillers.filter((_, i) => i !== index)
                    }
                }));
            };

            // AHUの操作
            const addAHU = () => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        ahus: [...prev.centralHVAC.ahus, { id: '', name: '', chillerId: '', airflow: 0 }]
                    }
                }));
            };

            const updateAHU = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        ahus: prev.centralHVAC.ahus.map((ahu, i) =>
                            i === index ? { ...ahu, [field]: value } : ahu
                        )
                    }
                }));
            };

            const deleteAHU = (index) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        ahus: prev.centralHVAC.ahus.filter((_, i) => i !== index)
                    }
                }));
            };

            // VAVの操作
            const addVAV = () => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        vavs: [...prev.centralHVAC.vavs, { id: '', name: '', ahuId: '', largeZoneId: '' }]
                    }
                }));
            };

            const updateVAV = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        vavs: prev.centralHVAC.vavs.map((vav, i) =>
                            i === index ? { ...vav, [field]: value } : vav
                        )
                    }
                }));
            };

            const deleteVAV = (index) => {
                setData(prev => ({
                    ...prev,
                    centralHVAC: {
                        ...prev.centralHVAC,
                        vavs: prev.centralHVAC.vavs.filter((_, i) => i !== index)
                    }
                }));
            };

            // VRFの操作
            const addVRF = () => {
                setData(prev => ({
                    ...prev,
                    individualHVAC: {
                        ...prev.individualHVAC,
                        vrfs: [...prev.individualHVAC.vrfs, { id: '', name: '', capacity: 0, powerRating: 0 }]
                    }
                }));
            };

            const updateVRF = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    individualHVAC: {
                        ...prev.individualHVAC,
                        vrfs: prev.individualHVAC.vrfs.map((vrf, i) =>
                            i === index ? { ...vrf, [field]: value } : vrf
                        )
                    }
                }));
            };

            const deleteVRF = (index) => {
                setData(prev => ({
                    ...prev,
                    individualHVAC: {
                        ...prev.individualHVAC,
                        vrfs: prev.individualHVAC.vrfs.filter((_, i) => i !== index)
                    }
                }));
            };

            // センサーの操作
            const addSensor = () => {
                setData(prev => ({
                    ...prev,
                    sensors: [...prev.sensors, { id: '', name: '', type: 'temperature', equipmentId: '', unit: '°C' }]
                }));
            };

            const updateSensor = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    sensors: prev.sensors.map((sensor, i) =>
                        i === index ? { ...sensor, [field]: value } : sensor
                    )
                }));
            };

            const deleteSensor = (index) => {
                setData(prev => ({
                    ...prev,
                    sensors: prev.sensors.filter((_, i) => i !== index)
                }));
            };

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'building':
                        return (
                            <div className="card">
                                <h2>建物基本情報</h2>
                                <div className="form-group">
                                    <label>建物ID</label>
                                    <input
                                        value={data.building.id}
                                        onChange={(e) => updateBuilding('id', e.target.value)}
                                        placeholder="Building_A"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>建物名</label>
                                    <input
                                        value={data.building.name}
                                        onChange={(e) => updateBuilding('name', e.target.value)}
                                        placeholder="東京グリーンタワー"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>所在地</label>
                                    <input
                                        value={data.building.location}
                                        onChange={(e) => updateBuilding('location', e.target.value)}
                                        placeholder="東京都千代田区"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>延床面積（㎡）</label>
                                    <input
                                        type="number"
                                        value={data.building.totalArea}
                                        onChange={(e) => updateBuilding('totalArea', parseFloat(e.target.value) || 0)}
                                    />
                                </div>
                            </div>
                        );

                    case 'floors':
                        return (
                            <div className="card">
                                <h2>階（{data.floors.length}）</h2>
                                <button className="btn btn-primary" onClick={addFloor}>階を追加</button>
                                <div className="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>名称</th>
                                                <th>面積（㎡）</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.floors.map((floor, index) => (
                                                <tr key={index}>
                                                    <td>
                                                        <input
                                                            value={floor.id}
                                                            onChange={(e) => updateFloor(index, 'id', e.target.value)}
                                                            placeholder="Floor_1"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={floor.name}
                                                            onChange={(e) => updateFloor(index, 'name', e.target.value)}
                                                            placeholder="1階"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            type="number"
                                                            value={floor.area}
                                                            onChange={(e) => updateFloor(index, 'area', parseFloat(e.target.value) || 0)}
                                                        />
                                                    </td>
                                                    <td>
                                                        <button className="delete-btn" onClick={() => deleteFloor(index)}>削除</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );

                    case 'zones':
                        return (
                            <div>
                                <div className="card">
                                    <h2>大ゾーン（全館空調担当）（{data.largeZones.length}）</h2>
                                    <button className="btn btn-primary" onClick={addLargeZone}>大ゾーン追加</button>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>名称</th>
                                                    <th>階</th>
                                                    <th>AHU</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.largeZones.map((zone, index) => (
                                                    <tr key={index}>
                                                        <td>
                                                            <input
                                                                value={zone.id}
                                                                onChange={(e) => updateLargeZone(index, 'id', e.target.value)}
                                                                placeholder="LargeZone_1A"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                value={zone.name}
                                                                onChange={(e) => updateLargeZone(index, 'name', e.target.value)}
                                                                placeholder="大ゾーン1A(東側エリア)"
                                                            />
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={zone.floorId}
                                                                onChange={(e) => updateLargeZone(index, 'floorId', e.target.value)}
                                                            >
                                                                <option value="">階を選択</option>
                                                                {data.floors.map(f => (
                                                                    <option key={f.id} value={f.id}>{f.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={zone.ahuId}
                                                                onChange={(e) => updateLargeZone(index, 'ahuId', e.target.value)}
                                                            >
                                                                <option value="">AHUを選択</option>
                                                                {data.centralHVAC.ahus.map(a => (
                                                                    <option key={a.id} value={a.id}>{a.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button className="delete-btn" onClick={() => deleteLargeZone(index)}>削除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="card" style={{marginTop: '20px'}}>
                                    <h2>小ゾーン（個別空調担当）（{data.smallZones.length}）</h2>
                                    <button className="btn btn-success" onClick={addSmallZone}>小ゾーン追加</button>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>名称</th>
                                                    <th>大ゾーン</th>
                                                    <th>VRF</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.smallZones.map((zone, index) => (
                                                    <tr key={index}>
                                                        <td>
                                                            <input
                                                                value={zone.id}
                                                                onChange={(e) => updateSmallZone(index, 'id', e.target.value)}
                                                                placeholder="SmallZone_1A1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                value={zone.name}
                                                                onChange={(e) => updateSmallZone(index, 'name', e.target.value)}
                                                                placeholder="小ゾーン1A1(会議室エリア)"
                                                            />
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={zone.largeZoneId}
                                                                onChange={(e) => updateSmallZone(index, 'largeZoneId', e.target.value)}
                                                            >
                                                                <option value="">大ゾーンを選択</option>
                                                                {data.largeZones.map(lz => (
                                                                    <option key={lz.id} value={lz.id}>{lz.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={zone.vrfId}
                                                                onChange={(e) => updateSmallZone(index, 'vrfId', e.target.value)}
                                                            >
                                                                <option value="">VRFを選択</option>
                                                                {data.individualHVAC.vrfs.map(v => (
                                                                    <option key={v.id} value={v.id}>{v.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button className="delete-btn" onClick={() => deleteSmallZone(index)}>削除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'rooms':
                        return (
                            <div className="card">
                                <h2>部屋（{data.rooms.length}）</h2>
                                <button className="btn btn-primary" onClick={addRoom}>部屋を追加</button>
                                <div className="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>名称</th>
                                                <th>小ゾーン</th>
                                                <th>面積（㎡）</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.rooms.map((room, index) => (
                                                <tr key={index}>
                                                    <td>
                                                        <input
                                                            value={room.id}
                                                            onChange={(e) => updateRoom(index, 'id', e.target.value)}
                                                            placeholder="Room_101"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={room.name}
                                                            onChange={(e) => updateRoom(index, 'name', e.target.value)}
                                                            placeholder="会議室101"
                                                        />
                                                    </td>
                                                    <td>
                                                        <select
                                                            value={room.smallZoneId}
                                                            onChange={(e) => updateRoom(index, 'smallZoneId', e.target.value)}
                                                        >
                                                            <option value="">小ゾーンを選択</option>
                                                            {data.smallZones.map(sz => (
                                                                <option key={sz.id} value={sz.id}>{sz.name}</option>
                                                            ))}
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input
                                                            type="number"
                                                            value={room.area}
                                                            onChange={(e) => updateRoom(index, 'area', parseFloat(e.target.value) || 0)}
                                                        />
                                                    </td>
                                                    <td>
                                                        <button className="delete-btn" onClick={() => deleteRoom(index)}>削除</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );

                    case 'central':
                        return (
                            <div>
                                <div className="card">
                                    <h2>チラー（{data.centralHVAC.chillers.length}）</h2>
                                    <button className="btn btn-primary" onClick={addChiller}>チラー追加</button>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>名称</th>
                                                    <th>容量（kW）</th>
                                                    <th>定格電力（kW）</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.centralHVAC.chillers.map((chiller, index) => (
                                                    <tr key={index}>
                                                        <td>
                                                            <input
                                                                value={chiller.id}
                                                                onChange={(e) => updateChiller(index, 'id', e.target.value)}
                                                                placeholder="Chiller_1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                value={chiller.name}
                                                                onChange={(e) => updateChiller(index, 'name', e.target.value)}
                                                                placeholder="チラー1号機"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                type="number"
                                                                value={chiller.capacity}
                                                                onChange={(e) => updateChiller(index, 'capacity', parseFloat(e.target.value) || 0)}
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                type="number"
                                                                value={chiller.powerRating}
                                                                onChange={(e) => updateChiller(index, 'powerRating', parseFloat(e.target.value) || 0)}
                                                            />
                                                        </td>
                                                        <td>
                                                            <button className="delete-btn" onClick={() => deleteChiller(index)}>削除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="card" style={{marginTop: '20px'}}>
                                    <h2>外調機（AHU）（{data.centralHVAC.ahus.length}）</h2>
                                    <button className="btn btn-primary" onClick={addAHU}>AHU追加</button>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>名称</th>
                                                    <th>チラー</th>
                                                    <th>風量（m³/h）</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.centralHVAC.ahus.map((ahu, index) => (
                                                    <tr key={index}>
                                                        <td>
                                                            <input
                                                                value={ahu.id}
                                                                onChange={(e) => updateAHU(index, 'id', e.target.value)}
                                                                placeholder="AHU_1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                value={ahu.name}
                                                                onChange={(e) => updateAHU(index, 'name', e.target.value)}
                                                                placeholder="外調機1号機"
                                                            />
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={ahu.chillerId}
                                                                onChange={(e) => updateAHU(index, 'chillerId', e.target.value)}
                                                            >
                                                                <option value="">チラーを選択</option>
                                                                {data.centralHVAC.chillers.map(c => (
                                                                    <option key={c.id} value={c.id}>{c.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <input
                                                                type="number"
                                                                value={ahu.airflow}
                                                                onChange={(e) => updateAHU(index, 'airflow', parseFloat(e.target.value) || 0)}
                                                            />
                                                        </td>
                                                        <td>
                                                            <button className="delete-btn" onClick={() => deleteAHU(index)}>削除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="card" style={{marginTop: '20px'}}>
                                    <h2>VAV（{data.centralHVAC.vavs.length}）</h2>
                                    <button className="btn btn-primary" onClick={addVAV}>VAV追加</button>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>名称</th>
                                                    <th>AHU</th>
                                                    <th>大ゾーン</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.centralHVAC.vavs.map((vav, index) => (
                                                    <tr key={index}>
                                                        <td>
                                                            <input
                                                                value={vav.id}
                                                                onChange={(e) => updateVAV(index, 'id', e.target.value)}
                                                                placeholder="VAV_1A1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <input
                                                                value={vav.name}
                                                                onChange={(e) => updateVAV(index, 'name', e.target.value)}
                                                                placeholder="VAV 1A-1"
                                                            />
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={vav.ahuId}
                                                                onChange={(e) => updateVAV(index, 'ahuId', e.target.value)}
                                                            >
                                                                <option value="">AHUを選択</option>
                                                                {data.centralHVAC.ahus.map(a => (
                                                                    <option key={a.id} value={a.id}>{a.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select
                                                                value={vav.largeZoneId}
                                                                onChange={(e) => updateVAV(index, 'largeZoneId', e.target.value)}
                                                            >
                                                                <option value="">大ゾーンを選択</option>
                                                                {data.largeZones.map(lz => (
                                                                    <option key={lz.id} value={lz.id}>{lz.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button className="delete-btn" onClick={() => deleteVAV(index)}>削除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'individual':
                        return (
                            <div className="card">
                                <h2>VRF（個別空調）（{data.individualHVAC.vrfs.length}）</h2>
                                <button className="btn btn-success" onClick={addVRF}>VRF追加</button>
                                <div className="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>名称</th>
                                                <th>容量（kW）</th>
                                                <th>定格電力（kW）</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.individualHVAC.vrfs.map((vrf, index) => (
                                                <tr key={index}>
                                                    <td>
                                                        <input
                                                            value={vrf.id}
                                                            onChange={(e) => updateVRF(index, 'id', e.target.value)}
                                                            placeholder="VRF_Unit_1"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={vrf.name}
                                                            onChange={(e) => updateVRF(index, 'name', e.target.value)}
                                                            placeholder="VRF室外機1号機"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            type="number"
                                                            value={vrf.capacity}
                                                            onChange={(e) => updateVRF(index, 'capacity', parseFloat(e.target.value) || 0)}
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            type="number"
                                                            value={vrf.powerRating}
                                                            onChange={(e) => updateVRF(index, 'powerRating', parseFloat(e.target.value) || 0)}
                                                        />
                                                    </td>
                                                    <td>
                                                        <button className="delete-btn" onClick={() => deleteVRF(index)}>削除</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );

                    case 'sensors':
                        return (
                            <div className="card">
                                <h2>センサー（{data.sensors.length}）</h2>
                                <button className="btn btn-primary" onClick={addSensor}>センサーを追加</button>
                                <div className="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>名称</th>
                                                <th>種類</th>
                                                <th>設備ID</th>
                                                <th>単位</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.sensors.map((sensor, index) => (
                                                <tr key={index}>
                                                    <td>
                                                        <input
                                                            value={sensor.id}
                                                            onChange={(e) => updateSensor(index, 'id', e.target.value)}
                                                            placeholder="Sensor_1"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={sensor.name}
                                                            onChange={(e) => updateSensor(index, 'name', e.target.value)}
                                                            placeholder="温度センサー"
                                                        />
                                                    </td>
                                                    <td>
                                                        <select
                                                            value={sensor.type}
                                                            onChange={(e) => updateSensor(index, 'type', e.target.value)}
                                                        >
                                                            <option value="temperature">温度</option>
                                                            <option value="humidity">湿度</option>
                                                            <option value="power">電力</option>
                                                            <option value="flow">流量</option>
                                                            <option value="position">位置</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={sensor.equipmentId}
                                                            onChange={(e) => updateSensor(index, 'equipmentId', e.target.value)}
                                                            placeholder="AHU_1"
                                                        />
                                                    </td>
                                                    <td>
                                                        <input
                                                            value={sensor.unit}
                                                            onChange={(e) => updateSensor(index, 'unit', e.target.value)}
                                                            placeholder="°C"
                                                        />
                                                    </td>
                                                    <td>
                                                        <button className="delete-btn" onClick={() => deleteSensor(index)}>削除</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );

                    default:
                        return <div>タブを選択してください</div>;
                }
            };

            return (
                <>
                    <div className="toolbar">
                        <h2 style={{flex: 1, fontSize: '18px'}}>建物モデルエディタ</h2>
                    </div>
                    <div className="content-area">
                        <div className="tab-container">
                            <div className="tabs">
                                <button
                                    className={`tab ${activeTab === 'building' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('building')}
                                >
                                    建物情報
                                </button>
                                <button
                                    className={`tab ${activeTab === 'floors' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('floors')}
                                >
                                    階
                                </button>
                                <button
                                    className={`tab ${activeTab === 'zones' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('zones')}
                                >
                                    ゾーン
                                </button>
                                <button
                                    className={`tab ${activeTab === 'rooms' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('rooms')}
                                >
                                    部屋
                                </button>
                                <button
                                    className={`tab ${activeTab === 'central' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('central')}
                                >
                                    全館空調
                                </button>
                                <button
                                    className={`tab ${activeTab === 'individual' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('individual')}
                                >
                                    個別空調
                                </button>
                                <button
                                    className={`tab ${activeTab === 'sensors' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('sensors')}
                                >
                                    センサー
                                </button>
                            </div>
                        </div>
                        {renderTabContent()}
                    </div>
                </>
            );
        };

        // センサーマッピングコンポーネント
        const SensorMapping = ({ generatedSensors, physicalSensors, mappings, onImportCSV, onPerformMapping, matchingMode, onMatchingModeChange }) => {
            return (
                <>
                    <div className="toolbar">
                        <h2 style={{flex: 1, fontSize: '18px'}}>センサーマッピング</h2>
                        <label className="btn btn-secondary">
                            具体センサーCSV読込
                            <input type="file" accept=".csv" onChange={onImportCSV} />
                        </label>
                        <button className="btn btn-primary" onClick={onPerformMapping}>
                            マッピング実行
                        </button>
                    </div>
                    <div className="content-area">
                        <div className="instruction-box">
                            <h3>センサーマッピングとは？</h3>
                            <p>
                                建物エディタで生成した論理的なセンサー（生成センサー）と、実際に建物に設置されている物理的なセンサー（具体センサー）を
                                自動的にマッピングします。具体センサーのCSVファイルを読み込み、マッチング方式を選択して、「マッピング実行」ボタンをクリックしてください。
                            </p>
                            <div style={{marginTop: '15px', padding: '15px', background: '#f8f9fa', borderRadius: '6px'}}>
                                <h4 style={{marginTop: 0, marginBottom: '10px', fontSize: '14px'}}>マッチング方式:</h4>
                                <div style={{display: 'flex', gap: '20px'}}>
                                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                                        <input
                                            type="radio"
                                            name="matchingMode"
                                            value="regex"
                                            checked={matchingMode === 'regex'}
                                            onChange={(e) => onMatchingModeChange(e.target.value)}
                                            style={{marginRight: '8px'}}
                                        />
                                        <span>
                                            <strong>正規表現マッチング</strong>
                                            <div style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                                パターンマッチングによる高速マッチング（APIキー不要）
                                            </div>
                                        </span>
                                    </label>
                                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                                        <input
                                            type="radio"
                                            name="matchingMode"
                                            value="ai"
                                            checked={matchingMode === 'ai'}
                                            onChange={(e) => onMatchingModeChange(e.target.value)}
                                            style={{marginRight: '8px'}}
                                        />
                                        <span>
                                            <strong>AIマッチング</strong>
                                            <div style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                                AIによる高精度マッチング（APIキー必要、階層情報を活用）
                                            </div>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h2>生成センサー一覧（建物エディタから）</h2>
                            <div className="sensor-list">
                                {generatedSensors.length === 0 ? (
                                    <p>建物エディタでセンサーを追加してください</p>
                                ) : (
                                    generatedSensors.map(sensor => (
                                        <div key={sensor.id} className="sensor-item">
                                            <div>
                                                <strong>{sensor.name}</strong>
                                                <div style={{fontSize: '12px', color: '#666'}}>
                                                    ID: {sensor.id} | タイプ: {sensor.type} | 設備: {sensor.equipmentId}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        <div className="card">
                            <h2>具体センサー一覧（CSVから読込）</h2>
                            <div className="sensor-list">
                                {physicalSensors.length === 0 ? (
                                    <p>CSVファイルから具体センサーを読み込んでください</p>
                                ) : (
                                    physicalSensors.map(sensor => (
                                        <div key={sensor.id} className="sensor-item">
                                            <div>
                                                <strong>{sensor.name}</strong>
                                                <div style={{fontSize: '12px', color: '#666'}}>
                                                    ID: {sensor.id} | タイプ: {sensor.type} | 場所: {sensor.location}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {mappings.length > 0 && (
                            <div className="card">
                                <h2>マッピング結果</h2>
                                <div className="mapping-result">
                                    {mappings.map((mapping, index) => (
                                        <div key={index} className="mapping-item">
                                            <div>
                                                <strong>{mapping.generatedSensorName}</strong>
                                                <div style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                                    → {mapping.physicalSensorName}
                                                </div>
                                                <div style={{fontSize: '11px', color: '#888', marginTop: '2px'}}>
                                                    {mapping.reason}
                                                </div>
                                            </div>
                                            <span className={`confidence-badge ${
                                                mapping.confidence > 0.8 ? 'confidence-high' :
                                                mapping.confidence > 0.6 ? 'confidence-medium' : 'confidence-low'
                                            }`}>
                                                {(mapping.confidence * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // チャットインターフェースコンポーネント
        const ChatInterface = ({ messages, onSendMessage, promptTemplate, setPromptTemplate, buildingData, sensorMappings }) => {
            const [inputMessage, setInputMessage] = useState('');
            const [showPromptEditor, setShowPromptEditor] = useState(false);
            const [showPromptPreview, setShowPromptPreview] = useState(false);
            const [debugMode, setDebugMode] = useState(false);
            const [expandedDebug, setExpandedDebug] = useState({});

            const handleSend = () => {
                if (inputMessage.trim()) {
                    onSendMessage(inputMessage);
                    setInputMessage('');
                }
            };

            const handleResetTemplate = () => {
                if (confirm('プロンプトテンプレートをデフォルトに戻しますか？')) {
                    setPromptTemplate(`あなたは建物のセンサー情報を検索・分析するAIアシスタントです。

以下の建物データが提供されます：
<building_data>
{buildingData}
</building_data>

以下のセンサーマッピング情報が提供されます：
<sensor_mapping>
{sensorMappings}
</sensor_mapping>

ユーザーからの質問に基づいて、該当するセンサーを特定し、生成センサー（generated sensor）と対応する物理センサー（physical sensor）の情報を併記してJSON形式で回答してください。

処理手順：
1. ユーザーの質問を分析し、求められているセンサーの種類や設置場所を特定する
2. 建物データのsensorsリストから、質問に該当するセンサーを検索する（センサー名、タイプ、設置場所などを考慮）
3. 特定した各センサーについて、センサーマッピング情報から対応する物理センサーの情報を取得する
4. 結果をJSON形式で出力する

出力形式：
\`\`\`json
{
  "sensorlist": [
    {
      "generated": "生成センサー名（generatedSensorName）",
      "concrete": "物理センサー名（physicalSensorName）"
    }
  ]
}
\`\`\`

注意事項：
- センサーマッピング情報にない生成センサーの場合は、"concrete"フィールドに"マッピング情報なし"と記載してください
- 質問に該当するセンサーが複数ある場合は、すべてリストに含めてください
- センサー名は正確にデータから取得してください

質問：
{query}`);
                    alert('デフォルトテンプレートに戻しました');
                }
            };

            const generatePromptPreview = () => {
                const exampleQuery = inputMessage || '会議室の温度センサーを教えて';
                return promptTemplate
                    .replace('{buildingData}', JSON.stringify(buildingData, null, 2))
                    .replace('{sensorMappings}', JSON.stringify(sensorMappings, null, 2))
                    .replace('{query}', exampleQuery);
            };

            const toggleDebugExpand = (index) => {
                setExpandedDebug(prev => ({
                    ...prev,
                    [index]: !prev[index]
                }));
            };

            return (
                <>
                    <div className="toolbar">
                        <h2 style={{flex: 1, fontSize: '18px'}}>自然言語クエリ</h2>
                        <button
                            className={`btn ${debugMode ? 'btn-primary' : 'btn-secondary'}`}
                            onClick={() => setDebugMode(!debugMode)}
                            style={{marginRight: '8px'}}
                            title="デバッグ情報の表示/非表示を切り替え"
                        >
                            {debugMode ? '🐛 デバッグON' : '🐛 デバッグ'}
                        </button>
                        <button
                            className="btn btn-secondary"
                            onClick={() => setShowPromptEditor(!showPromptEditor)}
                            style={{marginRight: '8px'}}
                        >
                            {showPromptEditor ? '📝 テンプレート編集を閉じる' : '📝 プロンプトテンプレート編集'}
                        </button>
                    </div>
                    <div className="content-area" style={{padding: 0, display: 'flex', flexDirection: 'column'}}>
                        {showPromptEditor && (
                            <div className="card" style={{margin: '20px', marginBottom: '10px'}}>
                                <h3>プロンプトテンプレート</h3>
                                <p style={{fontSize: '13px', color: '#666', marginBottom: '12px'}}>
                                    APIに送信されるプロンプトのテンプレートを編集できます。
                                    <code>{'{buildingData}'}</code>、<code>{'{sensorMappings}'}</code>、<code>{'{query}'}</code> はそれぞれ実際のデータに置き換えられます。
                                </p>
                                <div className="form-group">
                                    <textarea
                                        value={promptTemplate}
                                        onChange={(e) => setPromptTemplate(e.target.value)}
                                        rows="15"
                                        style={{fontFamily: 'monospace', fontSize: '13px', width: '100%'}}
                                        placeholder="プロンプトテンプレートを入力..."
                                    />
                                </div>
                                <div style={{display: 'flex', gap: '8px', marginTop: '8px'}}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={handleResetTemplate}
                                    >
                                        デフォルトに戻す
                                    </button>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => setShowPromptPreview(!showPromptPreview)}
                                    >
                                        {showPromptPreview ? 'プレビューを閉じる' : 'プレビュー表示'}
                                    </button>
                                </div>
                                {showPromptPreview && (
                                    <div style={{marginTop: '16px'}}>
                                        <h4 style={{fontSize: '14px', marginBottom: '8px'}}>プロンプトプレビュー</h4>
                                        <pre style={{
                                            background: '#f5f5f5',
                                            padding: '12px',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            maxHeight: '300px',
                                            overflow: 'auto',
                                            whiteSpace: 'pre-wrap',
                                            wordWrap: 'break-word'
                                        }}>
                                            {generatePromptPreview()}
                                        </pre>
                                        <p style={{fontSize: '12px', color: '#666', marginTop: '8px'}}>
                                            ※ 入力欄に質問がある場合はそれを使用、なければサンプル質問を使用してプレビューを生成しています
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="instruction-box" style={{margin: '20px', marginBottom: '10px', marginTop: showPromptEditor ? '10px' : '20px'}}>
                            <h3>自然言語でセンサーを検索</h3>
                            <p>
                                「会議室の温度センサーを教えて」「1階のセンサー一覧」などの自然な日本語で、
                                建物データから該当するセンサーを検索できます。マッピング済みの場合は具体センサー名も表示されます。
                            </p>
                        </div>

                        <div className="chat-container" style={{flex: 1}}>
                            <div className="chat-messages">
                                {messages.length === 0 ? (
                                    <div style={{textAlign: 'center', color: '#999', padding: '40px'}}>
                                        <p>質問を入力してください</p>
                                        <p style={{fontSize: '12px', marginTop: '8px'}}>
                                            例: 「会議室の温度センサーを教えて」
                                        </p>
                                    </div>
                                ) : (
                                    messages.map((msg, index) => (
                                        <div key={index}>
                                            <div className={`chat-message ${msg.role}`}>
                                                {msg.content}
                                            </div>
                                            {debugMode && msg.debug && (
                                                <div style={{
                                                    margin: '8px 20px',
                                                    padding: '12px',
                                                    background: '#f0f9ff',
                                                    border: '1px solid #bfdbfe',
                                                    borderRadius: '4px',
                                                    fontSize: '12px'
                                                }}>
                                                    <div style={{
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        marginBottom: '8px',
                                                        cursor: 'pointer'
                                                    }} onClick={() => toggleDebugExpand(index)}>
                                                        <strong style={{color: '#1e40af'}}>🐛 デバッグ情報</strong>
                                                        <span style={{color: '#64748b'}}>
                                                            {expandedDebug[index] ? '▼ 閉じる' : '▶ 展開'}
                                                        </span>
                                                    </div>
                                                    <div style={{
                                                        display: 'grid',
                                                        gridTemplateColumns: 'auto 1fr',
                                                        gap: '4px 12px',
                                                        color: '#475569'
                                                    }}>
                                                        <span style={{fontWeight: 'bold'}}>モード:</span>
                                                        <span style={{
                                                            color: msg.debug.mode.includes('API Mode') ? '#16a34a' : '#dc2626',
                                                            fontWeight: 'bold',
                                                            fontSize: '13px'
                                                        }}>
                                                            {msg.debug.mode}
                                                        </span>

                                                        {msg.debug.apiCallSuccess !== undefined && (
                                                            <>
                                                                <span style={{fontWeight: 'bold'}}>API呼び出し:</span>
                                                                <span style={{
                                                                    color: msg.debug.apiCallSuccess ? '#16a34a' : '#dc2626',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {msg.debug.apiCallSuccess ? '✓ 成功' : '✗ 失敗/未実行'}
                                                                </span>
                                                            </>
                                                        )}

                                                        {msg.debug.simulationNote && (
                                                            <>
                                                                <span style={{fontWeight: 'bold'}}>注意:</span>
                                                                <span style={{color: '#dc2626', fontSize: '12px'}}>
                                                                    {msg.debug.simulationNote}
                                                                </span>
                                                            </>
                                                        )}

                                                        {msg.debug.errorMessage && (
                                                            <>
                                                                <span style={{fontWeight: 'bold'}}>エラー:</span>
                                                                <span style={{color: '#dc2626', fontSize: '12px'}}>
                                                                    {msg.debug.errorMessage}
                                                                </span>
                                                            </>
                                                        )}

                                                        {msg.debug.isServerError && (
                                                            <>
                                                                <span style={{fontWeight: 'bold'}}>サーバーエラー:</span>
                                                                <span style={{
                                                                    color: '#dc2626',
                                                                    fontSize: '12px',
                                                                    fontWeight: 'bold',
                                                                    background: '#fee2e2',
                                                                    padding: '2px 6px',
                                                                    borderRadius: '3px'
                                                                }}>
                                                                    🔌 バックエンドサーバー未起動 - npm start で起動
                                                                </span>
                                                            </>
                                                        )}

                                                        <span style={{fontWeight: 'bold'}}>プロバイダー:</span>
                                                        <span>{msg.debug.provider}</span>

                                                        <span style={{fontWeight: 'bold'}}>モデル:</span>
                                                        <span>{msg.debug.model}</span>

                                                        <span style={{fontWeight: 'bold'}}>エンドポイント:</span>
                                                        <span style={{wordBreak: 'break-all'}}>{msg.debug.endpoint}</span>

                                                        <span style={{fontWeight: 'bold'}}>APIキー:</span>
                                                        <span>{msg.debug.hasApiKey ? '設定済み ✓' : '未設定 ✗'}</span>

                                                        <span style={{fontWeight: 'bold'}}>データサイズ:</span>
                                                        <span>{(msg.debug.buildingDataSize / 1024).toFixed(2)} KB</span>

                                                        <span style={{fontWeight: 'bold'}}>マッピング数:</span>
                                                        <span>{msg.debug.sensorMappingsCount}</span>

                                                        <span style={{fontWeight: 'bold'}}>レスポンス長:</span>
                                                        <span>{msg.debug.responseLength} 文字</span>

                                                        <span style={{fontWeight: 'bold'}}>タイムスタンプ:</span>
                                                        <span>{new Date(msg.debug.timestamp).toLocaleString('ja-JP')}</span>
                                                    </div>

                                                    {expandedDebug[index] && (
                                                        <>
                                                            <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #bfdbfe'}}>
                                                                <strong style={{color: '#1e40af'}}>実際に送信されるプロンプト:</strong>
                                                                <pre style={{
                                                                    marginTop: '8px',
                                                                    padding: '8px',
                                                                    background: '#fff',
                                                                    border: '1px solid #e2e8f0',
                                                                    borderRadius: '4px',
                                                                    fontSize: '11px',
                                                                    maxHeight: '400px',
                                                                    overflow: 'auto',
                                                                    whiteSpace: 'pre-wrap',
                                                                    wordWrap: 'break-word'
                                                                }}>
                                                                    {msg.debug.actualPrompt}
                                                                </pre>
                                                            </div>
                                                            <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #bfdbfe'}}>
                                                                <strong style={{color: '#1e40af'}}>プロンプトテンプレート:</strong>
                                                                <pre style={{
                                                                    marginTop: '8px',
                                                                    padding: '8px',
                                                                    background: '#fff',
                                                                    border: '1px solid #e2e8f0',
                                                                    borderRadius: '4px',
                                                                    fontSize: '11px',
                                                                    maxHeight: '200px',
                                                                    overflow: 'auto',
                                                                    whiteSpace: 'pre-wrap',
                                                                    wordWrap: 'break-word'
                                                                }}>
                                                                    {msg.debug.promptTemplate}
                                                                </pre>
                                                            </div>
                                                            <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #bfdbfe'}}>
                                                                <strong style={{color: '#1e40af'}}>APIレスポンス:</strong>
                                                                <div style={{
                                                                    marginTop: '8px',
                                                                    display: 'grid',
                                                                    gridTemplateColumns: 'auto 1fr',
                                                                    gap: '4px 12px',
                                                                    fontSize: '11px',
                                                                    color: '#475569',
                                                                    marginBottom: '8px'
                                                                }}>
                                                                    <span style={{fontWeight: 'bold'}}>レスポンス長:</span>
                                                                    <span>{msg.debug.responseLength} 文字</span>
                                                                    <span style={{fontWeight: 'bold'}}>レスポンス時刻:</span>
                                                                    <span>{new Date(msg.debug.responseTime).toLocaleString('ja-JP')}</span>
                                                                </div>
                                                                <pre style={{
                                                                    marginTop: '8px',
                                                                    padding: '8px',
                                                                    background: '#fff',
                                                                    border: '1px solid #e2e8f0',
                                                                    borderRadius: '4px',
                                                                    fontSize: '11px',
                                                                    maxHeight: '300px',
                                                                    overflow: 'auto',
                                                                    whiteSpace: 'pre-wrap',
                                                                    wordWrap: 'break-word'
                                                                }}>
                                                                    {msg.debug.rawResponse}
                                                                </pre>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                            <div className="chat-input-area">
                                <div className="chat-input">
                                    <textarea
                                        value={inputMessage}
                                        onChange={(e) => setInputMessage(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                handleSend();
                                            }
                                        }}
                                        placeholder="質問を入力してください..."
                                        rows="3"
                                    />
                                    <button className="btn btn-primary" onClick={handleSend}>
                                        送信
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // 設定コンポーネント
        const Settings = ({ apiKey, setApiKey, apiProvider, setApiProvider, apiModel, setApiModel, apiEndpoint, setApiEndpoint }) => {
            const [savedConfig, setSavedConfig] = useState(false);

            const handleSaveConfig = () => {
                // LocalStorageに保存（オプション）
                try {
                    localStorage.setItem('apiConfig', JSON.stringify({
                        provider: apiProvider,
                        model: apiModel,
                        endpoint: apiEndpoint
                    }));
                    setSavedConfig(true);
                    alert('API設定を保存しました');
                    setTimeout(() => setSavedConfig(false), 3000);
                } catch (e) {
                    console.error('設定の保存に失敗しました', e);
                }
            };

            const getModelOptions = () => {
                switch (apiProvider) {
                    case 'openai':
                        return [
                            { value: 'gpt-4o', label: 'GPT-4o' },
                            { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                            { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                            { value: 'gpt-4', label: 'GPT-4' },
                            { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
                        ];
                    case 'anthropic':
                        return [
                            { value: 'claude-sonnet-4-5', label: 'Claude Sonnet 4.5' },
                            { value: 'claude-haiku-4-5', label: 'Claude Haiku 4.5' },
                            { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet (Legacy)' },
                            { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus (Legacy)' }
                        ];
                    case 'google':
                        return [
                            { value: 'gemini-2.0-flash-exp', label: 'Gemini 2.0 Flash (Experimental)' },
                            { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
                            { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
                            { value: 'gemini-pro', label: 'Gemini Pro' }
                        ];
                    default:
                        return [];
                }
            };

            const getDefaultEndpoint = () => {
                switch (apiProvider) {
                    case 'openai':
                        return 'https://api.openai.com/v1';
                    case 'anthropic':
                        return 'https://api.anthropic.com/v1';
                    case 'google':
                        return 'https://generativelanguage.googleapis.com/v1';
                    default:
                        return '';
                }
            };

            const isConfigured = apiKey && apiKey.length > 0;

            return (
                <>
                    <div className="toolbar">
                        <h2 style={{flex: 1, fontSize: '18px'}}>API設定</h2>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span className={`status-indicator ${isConfigured ? 'status-connected' : 'status-disconnected'}`}></span>
                            <span style={{fontSize: '14px', color: isConfigured ? '#48bb78' : '#f56565'}}>
                                {isConfigured ? 'API設定済み' : 'API未設定'}
                            </span>
                        </div>
                    </div>
                    <div className="content-area">
                        {!isConfigured && (
                            <div className="api-config">
                                <h3>⚠️ API設定が必要です</h3>
                                <p style={{fontSize: '13px', color: '#92400e', marginTop: '8px'}}>
                                    AIマッピングと自然言語クエリを使用するには、APIキーを設定してください。
                                    現在の実装はシミュレーションモードで動作しています。
                                </p>
                            </div>
                        )}

                        <div className="api-config" style={{background: '#dcfce7', border: '1px solid #22c55e'}}>
                            <h3>✅ バックエンドサーバー経由でAPI呼び出し</h3>
                            <p style={{fontSize: '13px', color: '#166534', marginTop: '8px', marginBottom: '8px'}}>
                                <strong>このアプリケーションはバックエンドサーバー経由でAPI呼び出しを行います。</strong>
                                CORSエラーの心配はありません。
                            </p>
                            <p style={{fontSize: '12px', color: '#166534', marginBottom: '8px'}}>
                                <strong>サーバーの起動方法:</strong>
                            </p>
                            <ol style={{fontSize: '12px', color: '#166534', marginLeft: '20px', marginBottom: '8px'}}>
                                <li>ターミナルを開く</li>
                                <li><code>cd workbench</code> でディレクトリに移動</li>
                                <li><code>npm install</code> で依存パッケージをインストール（初回のみ）</li>
                                <li><code>npm start</code> でサーバーを起動</li>
                                <li>ブラウザで <code>http://localhost:3001/building_model_workbench.html</code> にアクセス</li>
                            </ol>
                            <p style={{fontSize: '12px', color: '#166534'}}>
                                <strong>セキュリティ:</strong> APIキーはバックエンドサーバーが安全に管理します。ブラウザに露出しません。
                            </p>
                            <p style={{fontSize: '12px', color: '#166534', marginTop: '8px'}}>
                                詳細は <code>README_SERVER.md</code> を参照してください。
                            </p>
                        </div>

                        <div className="card">
                            <h2>AI API設定</h2>

                            <div className="form-group">
                                <label>AIプロバイダー</label>
                                <select
                                    value={apiProvider}
                                    onChange={(e) => {
                                        setApiProvider(e.target.value);
                                        // プロバイダー変更時にデフォルトモデルを設定
                                        const provider = e.target.value;
                                        if (provider === 'openai') setApiModel('gpt-4o-mini');
                                        else if (provider === 'anthropic') setApiModel('claude-sonnet-4-5');
                                        else if (provider === 'google') setApiModel('gemini-1.5-flash');
                                        setApiEndpoint('');
                                    }}
                                >
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic (Claude)</option>
                                    <option value="google">Google (Gemini)</option>
                                </select>
                            </div>

                            <div className="form-group">
                                <label>モデル</label>
                                <select
                                    value={apiModel}
                                    onChange={(e) => setApiModel(e.target.value)}
                                >
                                    {getModelOptions().map(option => (
                                        <option key={option.value} value={option.value}>{option.label}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>APIキー</label>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder={
                                        apiProvider === 'openai' ? 'sk-...' :
                                        apiProvider === 'anthropic' ? 'sk-ant-...' :
                                        'API キーを入力'
                                    }
                                />
                                <p style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                    {apiProvider === 'openai' && 'OpenAI APIキーを入力してください（https://platform.openai.com/api-keys）'}
                                    {apiProvider === 'anthropic' && 'Anthropic APIキーを入力してください（https://console.anthropic.com/）'}
                                    {apiProvider === 'google' && 'Google AI Studio APIキーを入力してください（https://aistudio.google.com/app/apikey）'}
                                </p>
                            </div>

                            <div className="form-group">
                                <label>APIエンドポイント（オプション）</label>
                                <input
                                    type="text"
                                    value={apiEndpoint}
                                    onChange={(e) => setApiEndpoint(e.target.value)}
                                    placeholder={getDefaultEndpoint()}
                                />
                                <p style={{fontSize: '12px', color: '#666', marginTop: '4px'}}>
                                    カスタムエンドポイントを使用する場合のみ入力してください。空欄の場合はデフォルトが使用されます。
                                </p>
                            </div>

                            <button
                                className={`btn ${savedConfig ? 'btn-secondary' : 'btn-success'}`}
                                onClick={handleSaveConfig}
                            >
                                {savedConfig ? '✓ 保存済み' : '設定を保存'}
                            </button>
                        </div>

                        <div className="card">
                            <h2>現在の設定</h2>
                            <div style={{fontSize: '14px', lineHeight: '1.8'}}>
                                <div><strong>プロバイダー:</strong> {
                                    apiProvider === 'openai' ? 'OpenAI' :
                                    apiProvider === 'anthropic' ? 'Anthropic (Claude)' :
                                    apiProvider === 'google' ? 'Google (Gemini)' : '-'
                                }</div>
                                <div><strong>モデル:</strong> {apiModel || '-'}</div>
                                <div><strong>APIキー:</strong> {apiKey ? '設定済み (●●●●●●)' : '未設定'}</div>
                                <div><strong>エンドポイント:</strong> {apiEndpoint || getDefaultEndpoint()}</div>
                            </div>
                        </div>

                        <div className="card">
                            <h2>データパス設定</h2>
                            <div className="form-group">
                                <label>オントロジーファイルパス</label>
                                <input
                                    type="text"
                                    value="./building_ontology.ttl"
                                    readOnly
                                />
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // アプリケーションのレンダリング
        ReactDOM.render(<BuildingModelWorkbench />, document.getElementById('root'));
    </script>
</body>
</html>
