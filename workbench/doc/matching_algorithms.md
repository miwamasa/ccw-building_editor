# マッチングアルゴリズム

## 目次

1. [概要](#概要)
2. [正規表現ベースのマッチング](#正規表現ベースのマッチング)
3. [AIベースのマッチング](#aiベースのマッチング)
4. [マッチング方式の比較](#マッチング方式の比較)
5. [使用方法](#使用方法)
6. [マッチング精度の向上](#マッチング精度の向上)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

本ワークベンチは、生成センサー（論理的センサー）と具体センサー（物理的センサー）を自動的にマッピングする機能を提供します。2つのマッチングアルゴリズムから選択可能です：

### 1. 正規表現ベースのマッチング

- **特徴**: パターンマッチングによる高速処理
- **利点**: APIキー不要、完全にローカルで動作、高速
- **精度**: 中程度（スコアリングアルゴリズムに基づく）

### 2. AIベースのマッチング

- **特徴**: AI APIを使用したセマンティックマッチング
- **利点**: 高精度、建物階層構造を理解、自然言語的な対応関係を発見
- **精度**: 高（ただしAPIキーが必要）

---

## 正規表現ベースのマッチング

### アルゴリズム概要

正規表現ベースのマッチングは、センサーIDと物理センサー情報を解析し、複数の要素に基づいてスコアリングします。

### スコアリング基準

各マッチングは **0.0 ～ 1.0** のスコアで評価されます：

| 要素 | 配点 | 説明 |
|------|------|------|
| **エンティティIDマッチング** | 40% | 生成センサーのエンティティIDが物理センサー名に含まれるか |
| **エンティティタイプマッチング** | 25% | エンティティタイプのキーワードが含まれるか |
| **測定コンテキストマッチング** | 25% | 測定コンテキストのキーワードが含まれるか |
| **センサータイプ検証** | 必須 | タイプが一致しない場合は大幅減点（×0.3） |
| **ボーナスキーワード** | 最大10% | 追加のキーワード一致によるボーナス |

### 詳細なスコアリングロジック

#### 1. エンティティIDマッチング（40%）

生成センサーのエンティティIDが物理センサーの名前または場所に含まれるかを確認。

```javascript
// 生成センサーID: AHU:AHU_1:SUP_AIR:TEMP
// エンティティID: AHU_1

const entityIdLower = "ahu_1".replace(/_/g, ' '); // "ahu 1"

// 物理センサー名: "給気温度計1F-AHU1"
if (physicalSensorName.includes("ahu 1")) {
    score += 0.4;  // 完全一致
}

// 部分一致の場合
// words = ["ahu", "1"]
// matched = ["ahu", "1"] → 2/2 = 1.0
// score += 0.4 * 1.0 = 0.4
```

**例:**

| 生成センサー | 物理センサー名 | マッチ | スコア |
|-------------|---------------|--------|--------|
| `AHU:AHU_1:SUP_AIR:TEMP` | "給気温度計1F-AHU1" | ✓ | 0.4 |
| `ROM:Room_101:AMB:TEMP` | "会議室101温度センサー" | ✓ | 0.4 |
| `AHU:AHU_1:SUP_AIR:TEMP` | "給気温度計2F-AHU2" | ✗ | 0.2 (部分一致) |

#### 2. エンティティタイプマッチング（25%）

エンティティタイプのキーワードが物理センサー情報に含まれるかを確認。

```javascript
const ENTITY_TYPE_KEYWORDS = {
    'BLD': ['building', '建物'],
    'AHU': ['ahu', 'air handling unit', 'エアハンドリングユニット'],
    'ROM': ['room', '部屋'],
    'VRF': ['vrf', 'variable refrigerant flow'],
    // ...
};

// 生成センサー: AHU:AHU_1:SUP_AIR:TEMP
// エンティティタイプ: AHU
// キーワード: ['ahu', 'air handling unit', 'エアハンドリングユニット']

if (physicalSensorName.includes('ahu')) {
    score += 0.25;
}
```

**例:**

| エンティティタイプ | 物理センサー名 | マッチ | スコア |
|-------------------|---------------|--------|--------|
| `AHU` | "AHU1給気温度センサー" | ✓ | 0.25 |
| `ROM` | "会議室101温度センサー" | ✗ | 0 |
| `ROM` | "Room 101 temperature" | ✓ | 0.25 |

#### 3. 測定コンテキストマッチング（25%）

測定コンテキストのキーワードが物理センサー情報に含まれるかを確認。

```javascript
const MEASUREMENT_CONTEXT_KEYWORDS = {
    'OUT': ['outdoor', 'outside', '外気', '屋外'],
    'SUP_AIR': ['supply air', 'supply', '給気', 'SA'],
    'RET_AIR': ['return air', 'return', '還気', 'RA'],
    'AMB': ['ambient', 'room', 'zone', '室内', '環境'],
    // ...
};

// 生成センサー: AHU:AHU_1:SUP_AIR:TEMP
// コンテキスト: SUP_AIR
// キーワード: ['supply air', 'supply', '給気', 'SA']

if (physicalSensorName.includes('給気')) {
    score += 0.25;
}
```

**例:**

| コンテキスト | 物理センサー名 | マッチ | スコア |
|-------------|---------------|--------|--------|
| `SUP_AIR` | "給気温度計1F-AHU1" | ✓ | 0.25 |
| `OUT` | "外気温センサーA棟" | ✓ | 0.25 |
| `AMB` | "室内温度センサー" | ✓ | 0.25 |

#### 4. センサータイプ検証

センサータイプが一致しない場合は、スコアを大幅に減点。

```javascript
const SENSOR_TYPE_MAPPING = {
    'temperature': 'TEMP',
    'humidity': 'HUMD',
    'power': 'POWR',
    'flow': 'FLOW',
    // ...
};

// 生成センサー: AHU:AHU_1:SUP_AIR:TEMP
// センサータイプ: TEMP

// 物理センサータイプ: temperature
const expectedType = SENSOR_TYPE_MAPPING['temperature']; // 'TEMP'

if (expectedType !== 'TEMP') {
    score *= 0.3;  // 70%減点
}
```

**例:**

| 生成センサータイプ | 物理センサータイプ | 一致 | 影響 |
|-------------------|-------------------|------|------|
| `TEMP` | `temperature` | ✓ | なし |
| `TEMP` | `humidity` | ✗ | スコア × 0.3 |

#### 5. ボーナスキーワードマッチング（最大10%）

追加のキーワード一致によるボーナス。

```javascript
// ボーナスキーワード = [エンティティID, ...コンテキストキーワード]
const bonusKeywords = ["ahu_1", "supply air", "supply", "給気", "SA"];

// マッチしたキーワード数に応じてボーナス
const bonusMatches = 3; // 例: "ahu_1", "給気", "SA"がマッチ
const bonusScore = Math.min(0.1, bonusMatches * 0.02);
// bonusScore = min(0.1, 3 * 0.02) = 0.06
score += bonusScore;
```

### 完全な例

**生成センサー:**
```
AHU:AHU_1:SUP_AIR:TEMP
```

**物理センサー:**
```
id: PHY_TEMP_002
name: 給気温度計1F-AHU1
type: temperature
location: 1階機械室AHU1給気ダクト
```

**スコアリング:**

| 要素 | 判定 | スコア |
|------|------|--------|
| エンティティID (`ahu_1`) | ✓ "AHU1"に含まれる | +0.40 |
| エンティティタイプ (`ahu`) | ✓ "AHU"に含まれる | +0.25 |
| コンテキスト (`給気`) | ✓ "給気"に含まれる | +0.25 |
| センサータイプ | ✓ temperature = TEMP | 減点なし |
| ボーナス | 3キーワードマッチ | +0.06 |
| **合計** | | **0.96** |

**判定**: 信頼度 96% で高精度マッチ ✓

---

## AIベースのマッチング

### アルゴリズム概要

AIベースのマッチングは、大規模言語モデル（LLM）を使用して、セマンティックな理解に基づいたマッチングを行います。

### 主要な特徴

1. **オントロジー理解**: センサー命名規則の完全な理解
2. **階層構造の活用**: 建物の階層構造を動的に取得し、推論に活用
3. **自然言語的対応**: 日本語と英語の対応、略語の理解
4. **文脈理解**: センサーの設置場所や用途を理解

### プロンプト構成

AIマッチングのプロンプトは以下の要素で構成されます：

#### 1. システムプロンプト

```markdown
あなたは建物管理システムのセンサーマッチング専門家です。

## センサー命名規則

オントロジーベースのセンサーIDフォーマット:
`{EntityType}:{EntityID}:{MeasurementContext}:{SensorType}`

### EntityType (エンティティタイプ)
- BLD: Building (建物)
- AHU: Air Handling Unit (エアハンドリングユニット)
- ROM: Room (部屋)
...

### MeasurementContext (測定コンテキスト)
- OUT: 外気・屋外
- SUP_AIR: 給気
- AMB: 環境・室内
...

### SensorType (センサータイプ)
- TEMP: 温度
- HUMD: 湿度
- POWR: 電力
...
```

#### 2. 建物階層構造（動的生成）

```markdown
## 建物階層構造

■ 空間階層:
Building: Building_A (東京グリーンタワー)
  └─ Floor: Floor_1 (1階)
      └─ LargeZone: LargeZone_1A (東側ペリメーター)
          └─ SmallZone: SmallZone_1A1 (東側執務エリアA)
              └─ Room: Room_101 (会議室101)

■ 設備階層:
Chiller: Chiller_1
  └─ AHU: AHU_1
      └─ VAV: VAV_1A1 → LargeZone: LargeZone_1A (東側ペリメーター)

VRF: VRF_Unit_1
  ├─ SmallZone: SmallZone_1A1 (東側執務エリアA)
  └─ SmallZone: SmallZone_1A2 (東側執務エリアB)
```

**重要**: この階層情報は、`buildingData` から**動的に生成**されます。ハードコードされた情報ではありません。

#### 3. タスク定義

```markdown
## タスク

以下の生成センサー（論理センサー）と物理センサー（実センサー）のリストを元に、
最適なマッピングを行ってください。

各生成センサーに対して、最も適合する物理センサーを特定し、
信頼度スコア（0.0〜1.0）を付与してください。

### 生成センサーリスト:
[JSON形式でリスト]

### 物理センサーリスト:
[JSON形式でリスト]
```

#### 4. 出力形式

```json
{
  "mappings": [
    {
      "generatedSensorId": "AHU:AHU_1:SUP_AIR:TEMP",
      "physicalSensorId": "PHY_TEMP_002",
      "confidence": 0.95,
      "reason": "AHU1の給気温度センサーとして、エンティティID、測定コンテキスト、センサータイプが完全一致"
    }
  ]
}
```

### 動的階層生成の重要性

AIマッチングの精度を高めるため、建物の階層構造を動的に生成します：

```javascript
const generateHierarchyData = (buildingData) => {
    // 空間階層を動的に生成
    buildingData.floors.forEach(floor => {
        buildingData.largeZones
            .filter(lz => lz.floorId === floor.id)
            .forEach(lz => {
                // LargeZone → SmallZone → Room の階層を構築
            });
    });

    // 設備階層を動的に生成
    buildingData.centralHVAC.chillers.forEach(chiller => {
        // Chiller → AHU → VAV の接続関係を構築
    });

    // VRF階層を動的に生成
    buildingData.individualHVAC.vrfs.forEach(vrf => {
        // VRF → SmallZone の接続関係を構築
    });
};
```

### AI推論の例

**生成センサー:**
```json
{
  "id": "ROM:Room_101:AMB:TEMP",
  "name": "会議室101温度センサー",
  "type": "temperature"
}
```

**物理センサー候補:**
```json
[
  {
    "id": "PHY_TEMP_101",
    "name": "Room101温度計",
    "type": "temperature",
    "location": "1F会議室101"
  },
  {
    "id": "PHY_TEMP_102",
    "name": "Room102温度計",
    "type": "temperature",
    "location": "1F執務室102"
  }
]
```

**AI推論プロセス:**

1. **エンティティID解析**: `Room_101` → 会議室101に関連
2. **階層情報参照**: Room_101は SmallZone_1A1 内に存在
3. **物理センサー評価**:
   - PHY_TEMP_101: "Room101"と"会議室101"が一致 → 高スコア
   - PHY_TEMP_102: "Room102"は異なる → 低スコア
4. **結論**: PHY_TEMP_101を選択、信頼度 0.95

**出力:**
```json
{
  "generatedSensorId": "ROM:Room_101:AMB:TEMP",
  "physicalSensorId": "PHY_TEMP_101",
  "confidence": 0.95,
  "reason": "会議室101の環境温度センサーとして、部屋番号とセンサータイプが完全一致。階層構造からも整合性が確認できる。"
}
```

---

## マッチング方式の比較

| 項目 | 正規表現マッチング | AIマッチング |
|------|-------------------|--------------|
| **APIキー** | 不要 | 必要 |
| **処理速度** | 高速（即時） | 中速（APIコール） |
| **精度** | 中程度（70-85%） | 高精度（85-95%） |
| **コスト** | 無料 | APIコスト発生 |
| **オフライン動作** | 可能 | 不可 |
| **階層理解** | なし | あり |
| **自然言語理解** | 限定的 | 高度 |
| **設定の複雑さ** | 簡単 | 中程度（APIキー設定） |
| **適用シーン** | 開発・テスト、小規模 | 本番環境、高精度が必要な場合 |

### 推奨用途

**正規表現マッチング:**
- 開発・テスト環境
- APIキーが利用できない環境
- オフライン環境
- 高速処理が必要な場合
- センサー命名が統一されている場合

**AIマッチング:**
- 本番環境
- 高精度が求められる場合
- センサー命名に揺らぎがある場合
- 複雑な建物階層を持つ場合
- 初回のマッピング確立時

---

## 使用方法

### 1. マッチング方式の選択

ワークベンチの「センサーマッピング」画面で、マッチング方式を選択します：

- **正規表現マッチング**: すぐに使用可能
- **AIマッチング**: 事前にAPI設定が必要

### 2. 物理センサーCSVの準備

CSV形式で物理センサー情報を準備：

```csv
id,name,type,location,unit
PHY_TEMP_001,外気温センサーA棟,temperature,建物外壁東側,°C
PHY_TEMP_002,給気温度計1F-AHU1,temperature,1階機械室AHU1給気ダクト,°C
```

### 3. マッピング実行

1. 「具体センサーCSV読込」で物理センサーを読み込み
2. マッチング方式を選択
3. 「マッピング実行」をクリック
4. 結果を確認

### 4. 結果の解釈

マッピング結果には以下の情報が含まれます：

- **生成センサー名**: 論理的なセンサー
- **物理センサー名**: 実際のセンサー
- **信頼度スコア**: 0.0-1.0（1.0が最高）
- **理由**: マッチングの根拠

**信頼度スコアの目安:**

| スコア | 評価 | 対応 |
|--------|------|------|
| 0.9-1.0 | 高信頼度 | そのまま採用可能 |
| 0.7-0.9 | 中信頼度 | 確認推奨 |
| 0.5-0.7 | 低信頼度 | 手動確認必須 |
| < 0.5 | マッチなし | 表示されない |

---

## マッチング精度の向上

### 正規表現マッチングの精度向上

1. **センサー命名の統一化**
   - エンティティIDを明確に記載
   - 測定コンテキストのキーワードを含める

   **良い例:**
   ```
   id: PHY_TEMP_AHU1_SA
   name: 給気温度計AHU1
   location: 1階機械室AHU1給気ダクト
   ```

   **悪い例:**
   ```
   id: TEMP_001
   name: 温度計
   location: 1階
   ```

2. **場所情報の充実**
   - location フィールドに詳細な設置場所を記載
   - エンティティIDや機器名を含める

### AIマッチングの精度向上

1. **建物データの整備**
   - 階層構造を正確に設定
   - 機器の接続関係を明確化

2. **センサー名の充実**
   - 日本語名を分かりやすく記載
   - セマンティックタグを活用

3. **適切なAIモデルの選択**
   - GPT-4: 最高精度、高コスト
   - GPT-4o-mini: バランス型、推奨
   - GPT-3.5-turbo: 低コスト、精度やや低

---

## トラブルシューティング

### Q1: マッチング結果が少ない

**原因:**
- センサータイプが一致していない
- エンティティIDの命名が大きく異なる
- 信頼度スコアが0.5未満

**対策:**
- センサータイプを確認・修正
- 物理センサー名にエンティティIDを含める
- AIマッチングを試す

### Q2: 誤ったマッチングが多い

**原因:**
- 物理センサーの命名が曖昧
- 同じ名前のセンサーが複数存在

**対策:**
- 物理センサーのlocationを充実
- 一意な識別情報を追加
- 信頼度スコアの閾値を上げる（0.5 → 0.7）

### Q3: AIマッチングでエラーが発生

**原因:**
- APIキーが無効
- 建物データの一部が未定義

**対策:**
- API設定を確認
- サンプルデータを読み込み
- ブラウザコンソールでエラーを確認

---

## 関連ドキュメント

- [オントロジー解説](ontology_guide.md)
- [センサー命名規則](sensor_naming_rules.md)
- [自然言語クエリプロンプト](natural_language_query.md)

---

**最終更新**: 2025-11-22
