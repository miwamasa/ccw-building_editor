# 建物モデルワークベンチ (Building Model Workbench)

## 概要

建物モデルワークベンチは、ハイブリッド空調システムの建物情報を統合管理するための包括的なツールです。以下の機能を統合しています：

1. **建物モデルエディタ**: 建物構造、設備、センサーの入力・編集（JSON入出力対応）
2. **センサーマッピング**: 論理的な生成センサーと物理的な具体センサーの自動マッピング（正規表現 + AI）
3. **自然言語クエリ**: 日本語での問い合わせによるセンサー情報の検索
4. **オントロジー管理**: Brick Schemaベースのオントロジー定義

## ファイル構成

```
workbench/
├── building_model_workbench.html   # メインアプリケーション（Webブラウザで開く）
├── building_ontology.ttl           # 建物オントロジー定義（Turtle形式）
├── sample_physical_sensors.csv     # 具体センサーのサンプルデータ
├── README.md                       # このファイル
└── doc/                            # ドキュメント
    ├── ontology_guide.md           # オントロジー解説
    ├── sensor_naming_rules.md      # センサー命名規則
    ├── matching_algorithms.md      # マッチングアルゴリズム
    └── natural_language_query.md   # 自然言語クエリプロンプト
```

## クイックスタート

### 1. バックエンドサーバーの起動（AI機能を使用する場合）

AI機能（AIマッチング、自然言語クエリ）を使用する場合は、バックエンドサーバーを起動する必要があります。

**起動方法:**

```bash
# プロジェクトのルートディレクトリで実行
npm install  # 初回のみ
npm start
```

サーバーが `http://localhost:3001` で起動します。

**企業ネットワークでSSL証明書エラーが発生する場合:**

```bash
# Windows PowerShell
$env:NODE_TLS_REJECT_UNAUTHORIZED="0"
npm start

# Mac/Linux
NODE_TLS_REJECT_UNAUTHORIZED=0 npm start
```

⚠️ **注意**: SSL証明書検証の無効化は開発環境でのみ使用してください。

### 2. アプリケーションの起動

1. `building_model_workbench.html` をWebブラウザ（Chrome、Firefox、Edge等）で開きます
2. ブラウザ上で動作するため、インストール不要です

### 3. サンプルデータの読み込み

1. 左サイドバーの「サンプルデータ読込」ボタンをクリック
2. 東京グリーンタワーのサンプルデータが自動的に読み込まれます

### 4. 各機能の使い方

#### 📝 建物モデルエディタ

建物の構造、設備、センサーを入力・編集します。

**使用手順：**
1. 左サイドバーの「建物モデルエディタ」をクリック
2. タブを切り替えて各種データを入力：
   - **建物情報**: 建物ID、名称、所在地、延床面積
   - **階**: 各階の情報（ID、名称、面積）
   - **センサー**: センサー情報（ID、名称、種類、設備ID、単位）

**データの保存：**
- 「JSONエクスポート」ボタンでJSONファイルとしてダウンロード
- 「JSONインポート」ボタンで保存したJSONファイルを読み込み

#### 🔗 センサーマッピング

生成センサー（論理的）と具体センサー（物理的）を自動的にマッピングします。2つのマッチング方式から選択可能です。

**使用手順：**
1. 左サイドバーの「センサーマッピング」をクリック
2. 「具体センサーCSV読込」ボタンで `sample_physical_sensors.csv` を読み込み
3. マッチング方式を選択：
   - **正規表現マッチング**: パターンマッチングによる高速処理（APIキー不要）
   - **AIマッチング**: AI APIによる高精度マッチング（APIキー必要）
4. 「マッピング実行」ボタンをクリック
5. マッピング結果が表示されます（信頼度スコア付き）

**マッチングロジック：**

*正規表現マッチング:*
- エンティティIDマッチング（40%）
- エンティティタイプマッチング（25%）
- 測定コンテキストマッチング（25%）
- センサータイプ検証
- ボーナスキーワードマッチング（最大10%）

*AIマッチング:*
- オントロジーベースの命名規則理解
- 建物階層構造の動的活用
- セマンティックな関連性分析
- 信頼度スコア（0.5以上）と理由の提示

**詳細**: [マッチングアルゴリズム詳細](doc/matching_algorithms.md)

#### 💬 自然言語クエリ

日本語での問い合わせでセンサー情報を検索します。

**使用手順：**
1. 左サイドバーの「自然言語クエリ」をクリック
2. チャット入力欄に質問を入力（例：「会議室の温度センサーを教えて」）
3. 「送信」ボタンをクリック
4. AIが該当するセンサー情報を返答します

**クエリ例：**
- 「会議室の温度センサーを教えて」
- 「1階のセンサー一覧」
- 「外調機のセンサー」
- 「AHU_1の温度センサー」

#### ⚙️ API設定

AI機能を使用するためのAPI設定を行います。

**使用手順：**
1. 左サイドバーの「API設定」をクリック
2. APIキーを入力（OpenAI APIまたは互換性のあるAPI）
3. 「設定を保存」ボタンをクリック

**注意：** 現在の実装はシミュレーションモードで動作するため、APIキーがなくても基本機能は使用できます。

## データ形式

### 建物データ（JSON）

```json
{
  "building": {
    "id": "Building_A",
    "name": "東京グリーンタワー",
    "location": "東京都千代田区",
    "totalArea": 2400
  },
  "floors": [
    {
      "id": "Floor_1",
      "name": "1階",
      "area": 1200
    }
  ],
  "sensors": [
    {
      "id": "AHU1_Outside_Air_Temp",
      "name": "外調機1_外気温度センサー",
      "type": "temperature",
      "equipmentId": "AHU_1",
      "unit": "°C"
    }
  ]
}
```

### 具体センサーデータ（CSV）

```csv
id,name,type,location,unit
PHY_TEMP_001,外気温センサーA棟,temperature,建物外壁東側,°C
PHY_TEMP_002,給気温度計1F-AHU1,temperature,1階機械室AHU1給気ダクト,°C
```

**フィールド説明：**
- `id`: センサーの一意識別子
- `name`: センサーの名称
- `type`: センサータイプ（temperature, humidity, power, flow, position）
- `location`: 物理的な設置場所
- `unit`: 測定単位

## オントロジー（building_ontology.ttl）

Brick Schemaを拡張した建物モデル用オントロジーです。

**主要なクラス：**
- `wb:BuildingModel`: 建物モデル
- `wb:GeneratedSensor`: 生成センサー（論理的）
- `wb:PhysicalSensor`: 具体センサー（物理的）
- `wb:SensorMapping`: センサーマッピング関係

**主要なプロパティ：**
- `wb:mapsToPhysicalSensor`: 生成センサーと具体センサーの対応
- `wb:hasConfidenceScore`: マッピングの信頼度スコア
- `wb:hasSemanticTag`: 自然言語検索用のタグ

## 使用例

### シナリオ1: 新規建物データの作成

1. 建物モデルエディタで建物情報を入力
2. 階、ゾーン、部屋を追加
3. 設備（チラー、AHU、VRF等）を追加
4. センサーを配置
5. JSONエクスポートで保存

### シナリオ2: センサーマッピングの実行

1. サンプルデータを読み込み
2. `sample_physical_sensors.csv` を読み込み
3. AIマッピング実行
4. マッピング結果を確認
5. 信頼度が低いマッピングを手動で調整

### シナリオ3: 自然言語での情報検索

1. サンプルデータとマッピングを実行
2. 自然言語クエリで「会議室101の温度センサーを教えて」と入力
3. 生成センサー名と具体センサー名が表示される
4. 必要に応じて追加の質問を行う

## システム要件

- **ブラウザ**: Chrome、Firefox、Edge、Safari（最新版推奨）
- **JavaScript**: 有効化が必要
- **ネットワーク**: React、Babelライブラリの読み込みのためインターネット接続が必要

## 技術スタック

- **フロントエンド**: React 18
- **スタイリング**: カスタムCSS
- **データ形式**: JSON、CSV、Turtle（TTL）
- **オントロジー**: Brick Schema 1.4.4

## カスタマイズ

### センサータイプの追加

`building_model_workbench.html` の以下の部分を編集：

```javascript
<select value={sensor.type}>
    <option value="temperature">温度</option>
    <option value="humidity">湿度</option>
    <option value="power">電力</option>
    <option value="flow">流量</option>
    <option value="custom">カスタム</option>  // 追加
</select>
```

### AIマッピングロジックの改善

`performSensorMapping` 関数内のマッチングロジックをカスタマイズできます。

### 自然言語クエリの拡張

`generateAIResponse` 関数に新しいパターンマッチングを追加できます。

## トラブルシューティング

### Q1: ページが表示されない
**A**: ブラウザのJavaScriptが有効になっているか確認してください。コンソールエラーをチェックしてください。

### Q2: CSVファイルが読み込めない
**A**: CSVファイルの形式が正しいか確認してください。カンマ区切り、UTF-8エンコーディングである必要があります。

### Q3: マッピング結果が表示されない
**A**:
- 建物エディタでセンサーが追加されているか確認
- 具体センサーCSVが読み込まれているか確認
- センサータイプが一致しているか確認

### Q4: JSONエクスポートができない
**A**: ブラウザのダウンロード設定を確認してください。ポップアップブロッカーが無効になっているか確認してください。

## 今後の拡張

- [ ] 実際のAI API統合（OpenAI、Claude等）
- [ ] オントロジーとの双方向同期
- [ ] SPARQLクエリインターフェース
- [ ] マッピング結果のTTLエクスポート
- [ ] 建物データの可視化（図面、3Dモデル）
- [ ] センサーデータの時系列表示
- [ ] マルチユーザー対応
- [ ] データベース連携

## 参考情報

### 関連ドキュメント

**本ワークベンチのドキュメント:**
- [オントロジー解説](doc/ontology_guide.md): Brick Schemaベースのオントロジー詳細
- [センサー命名規則](doc/sensor_naming_rules.md): オントロジーベースのセンサー命名規則
- [マッチングアルゴリズム](doc/matching_algorithms.md): 正規表現とAIマッチングの詳細
- [自然言語クエリプロンプト](doc/natural_language_query.md): AIクエリシステムの仕組み

**その他のドキュメント:**
- `../the_building_informationmodel/README.md`: 建物情報モデルの詳細
- `../the_building_editor/EDITOR_GUIDE.md`: エディタの使用ガイド
- [Brick Schema 公式サイト](https://brickschema.org/)

### 既存の情報モデル

本ワークベンチは以下の既存モデルを参考に構築されています：

- `the_building_informationmodel/hvac_information_model.ttl`: HVACシステムの情報モデル
- `the_building_editor/sample_building_data.json`: サンプル建物データ

## ライセンス

本ワークベンチはBrick Schema（Apache 2.0 License）をベースにしています。

## 貢献

改善提案やバグレポートは、プロジェクト担当者までご連絡ください。

## バージョン履歴

- **1.1** (2025-11-22): センサーマッチング強化
  - オントロジーベースのセンサー命名規則実装
  - 正規表現ベースのマッチングアルゴリズム追加
  - AIベースのマッチングアルゴリズム追加（階層情報の動的生成）
  - マッチング方式の切り替えUI実装
  - 包括的なドキュメント整備

- **1.0** (2025-11-22): 初版リリース
  - 建物モデルエディタ
  - センサーマッピング基本機能
  - 自然言語クエリシステム
  - オントロジー定義

---

**作成日**: 2025-11-22
**更新日**: 2025-11-22
**バージョン**: 1.1
